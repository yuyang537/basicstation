graph TB
    subgraph "LoRaWAN帧格式结构"
        subgraph "MHDR字段结构 (1字节)"
            A[Bit 7-5: 帧类型<br/>Frame Type] 
            B[Bit 4-2: RFU<br/>预留字段必须为0]
            C[Bit 1-0: 主版本<br/>Major Version]
            A --> A1["000: Join Request<br/>001: Join Accept<br/>010: Data Up (unconf)<br/>011: Data Down (unconf)<br/>100: Data Up (conf)<br/>101: Data Down (conf)<br/>110: Rejoin<br/>111: Proprietary"]
            C --> C1["00: LoRaWAN v1.x"]
        end
        
        subgraph "Join Request帧格式 (23字节固定)"
            D[MHDR<br/>1字节] --> E[JoinEUI<br/>8字节小端序]
            E --> F[DevEUI<br/>8字节小端序]
            F --> G[DevNonce<br/>2字节小端序]
            G --> H[MIC<br/>4字节小端序]
            
            D1[偏移0] --> E1[偏移1-8]
            E1 --> F1[偏移9-16]
            F1 --> G1[偏移17-18]
            G1 --> H1[偏移19-22]
        end
        
        subgraph "Data帧格式 (12+字节可变)"
            I[MHDR<br/>1字节] --> J[DevAddr<br/>4字节小端序]
            J --> K[FCtrl<br/>1字节]
            K --> L[FCnt<br/>2字节小端序]
            L --> M[FOpts<br/>0-15字节]
            M --> N[FPort<br/>0-1字节]
            N --> O[载荷<br/>0-?字节]
            O --> P[MIC<br/>4字节小端序]
            
            I1[偏移0] --> J1[偏移1-4]
            J1 --> K1[偏移5]
            K1 --> L1[偏移6-7]
            L1 --> M1[偏移8+]
            M1 --> N1[偏移8+FOpts长度]
            N1 --> O1[偏移9+FOpts长度]
            O1 --> P1[偏移len-4到len-1]
        end
        
        subgraph "FCtrl字段结构"
            K --> Q[Bit 7: ADR]
            Q --> R[Bit 6: ADRACKReq]
            R --> S[Bit 5: ACK]
            S --> T[Bit 4: ClassB]
            T --> U[Bit 3-0: FOptsLen<br/>0-15字节]
        end
        
        subgraph "DevAddr字段结构"
            J --> V[Bit 31-25: NetID<br/>网络标识符7位]
            V --> W[Bit 24-0: NwkAddr<br/>网络内设备地址25位]
        end
        
        subgraph "信标帧格式 (可变长度)"
            X[RFU<br/>n字节] --> Y[GPS时间<br/>4字节小端序]
            Y --> Z[CRC1<br/>2字节小端序]
            Z --> AA[InfoDesc<br/>1字节]
            AA --> BB[纬度<br/>3字节小端序]
            BB --> CC[经度<br/>3字节小端序]
            CC --> DD[RFU<br/>n字节]
            DD --> EE[CRC2<br/>2字节小端序]
        end
        
        subgraph "地理坐标编码"
            BB --> FF["纬度编码:<br/>lat / 90 * (1<<31)<br/>-90°到+90°映射到31位"]
            CC --> GG["经度编码:<br/>lon / 180 * (1<<31)<br/>-180°到+180°映射到31位"]
        end
        
        subgraph "过滤器结构"
            HH[JoinEUI过滤器] --> II["范围数组格式:<br/>[min1, max1, min2, max2, ..., 0]"]
            JJ[NetID过滤器] --> KK["位掩码数组:<br/>4个32位整数<br/>每位对应一个NetID"]
            KK --> LL["索引计算:<br/>netid>>5 (数组索引)<br/>netid&0x1F (位索引)"]
        end
    end

    classDef headerField fill:#e3f2fd
    classDef joinFrame fill:#f1f8e9
    classDef dataFrame fill:#fff3e0
    classDef controlField fill:#fce4ec
    classDef beaconFrame fill:#f3e5f5
    classDef filterSystem fill:#e8f5e8

    class A,B,C,A1,C1 headerField
    class D,E,F,G,H,D1,E1,F1,G1,H1 joinFrame
    class I,J,K,L,M,N,O,P,I1,J1,K1,L1,M1,N1,O1,P1 dataFrame
    class Q,R,S,T,U,V,W controlField
    class X,Y,Z,AA,BB,CC,DD,EE,FF,GG beaconFrame
    class HH,II,JJ,KK,LL filterSystem 