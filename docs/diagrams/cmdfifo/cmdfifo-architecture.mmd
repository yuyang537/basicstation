graph TB
    subgraph "命令FIFO系统架构 (CMDFIFO)"
        subgraph "外部命令输入层"
            CLI["命令行客户端<br/>• shell命令<br/>• 脚本程序<br/>• 管理工具<br/>• 监控系统"]
            
            FIFO_FILE["命名管道文件<br/>• FIFO特殊文件<br/>• 多写入端支持<br/>• 非阻塞读取<br/>• 自动重连机制"]
            
            PIPES["管道操作<br/>• echo命令写入<br/>• 重定向输出<br/>• cat命令传输<br/>• printf格式化"]
        end
        
        subgraph "FIFO管理层"
            REOPEN["连接管理<br/>fifo_reopen()<br/>• 文件状态检查<br/>• FIFO类型验证<br/>• 文件描述符创建<br/>• AIO事件注册"]
            
            TIMER["重连定时器<br/>reopen_timeout()<br/>• 定期重连尝试<br/>• 失败重试机制<br/>• 连接恢复策略<br/>• 定时器管理"]
            
            CLEANUP["资源清理<br/>fifo_close()<br/>• AIO连接关闭<br/>• 文件描述符清理<br/>• 状态重置<br/>• 退出时清理"]
        end
        
        subgraph "数据处理层"
            AIO["异步IO处理<br/>fifo_read()<br/>• 事件驱动读取<br/>• 非阻塞操作<br/>• 数据缓冲管理<br/>• EOF处理"]
            
            BUFFER["缓冲区管理<br/>cmdline[PIPE_BUF]<br/>• 数据累积<br/>• 行分割处理<br/>• 缓冲区重组<br/>• 溢出保护"]
            
            PARSER["命令解析器<br/>• 换行符检测<br/>• JSON格式识别<br/>• 文本命令处理<br/>• 错误处理"]
        end
        
        subgraph "命令分发层"
            TYPE_CHECK["命令类型检查<br/>cmdline[0] == '{'<br/>• JSON格式检测<br/>• 文本命令识别<br/>• 分发路由选择"]
            
            LOG_CMD["日志命令处理<br/>log_str2level()<br/>• 日志级别解析<br/>• 动态级别设置<br/>• 系统配置更新"]
            
            JSON_CMD["JSON命令处理<br/>• TC模块状态检查<br/>• 发送缓冲区获取<br/>• WebSocket转发<br/>• 错误处理"]
        end
        
        subgraph "输出集成层"
            TC_MODULE["TC传输模块<br/>• WebSocket连接<br/>• LNS服务器通信<br/>• 发送缓冲管理<br/>• 网络状态监控"]
            
            LOG_SYSTEM["日志系统<br/>• 级别动态控制<br/>• 输出格式管理<br/>• 日志文件写入<br/>• 控制台输出"]
            
            ERROR_LOG["错误处理<br/>• 命令执行失败<br/>• 连接断开处理<br/>• 缓冲区满处理<br/>• 未知命令处理"]
        end
    end
    
    subgraph "外部系统接口"
        SHELL["Shell环境<br/>• bash/sh命令<br/>• 脚本自动化<br/>• 管道重定向<br/>• 进程通信"]
        
        LNS["LoRaWAN网络服务器<br/>• JSON协议<br/>• WebSocket连接<br/>• 命令响应<br/>• 状态查询"]
        
        MONITOR["监控系统<br/>• 系统状态查询<br/>• 配置动态修改<br/>• 日志级别控制<br/>• 实时命令执行"]
    end
    
    subgraph "配置与初始化"
        ENABLE["功能启用<br/>sys_enableCmdFIFO()<br/>• FIFO路径设置<br/>• 定时器初始化<br/>• 首次连接启动"]
        
        CONFIG["系统配置<br/>• FIFO文件路径<br/>• 重连间隔时间<br/>• 缓冲区大小<br/>• 错误处理策略"]
        
        INTEGRATION["模块集成<br/>• AIO事件系统<br/>• RT定时器系统<br/>• TC传输模块<br/>• 日志系统"]
    end
    
    %% 数据流连接
    CLI --> FIFO_FILE
    PIPES --> FIFO_FILE
    FIFO_FILE --> REOPEN
    
    REOPEN --> AIO
    TIMER --> REOPEN
    AIO --> BUFFER
    BUFFER --> PARSER
    
    PARSER --> TYPE_CHECK
    TYPE_CHECK --> LOG_CMD
    TYPE_CHECK --> JSON_CMD
    
    LOG_CMD --> LOG_SYSTEM
    JSON_CMD --> TC_MODULE
    
    TC_MODULE --> LNS
    LOG_SYSTEM --> MONITOR
    ERROR_LOG --> LOG_SYSTEM
    
    %% 控制流连接
    CLEANUP --> REOPEN
    TIMER --> CLEANUP
    AIO --> TIMER
    
    SHELL --> CLI
    SHELL --> PIPES
    
    ENABLE --> CONFIG
    CONFIG --> INTEGRATION
    INTEGRATION --> REOPEN
    
    %% 错误处理连接
    REOPEN --> ERROR_LOG
    AIO --> ERROR_LOG
    JSON_CMD --> ERROR_LOG
    
    %% 样式定义
    classDef inputLayer fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef fifoMgmt fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef dataProc fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef cmdDispatch fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef outputInteg fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef external fill:#fce4ec,stroke:#ad1457,stroke-width:2px
    classDef config fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class CLI,FIFO_FILE,PIPES inputLayer
    class REOPEN,TIMER,CLEANUP fifoMgmt
    class AIO,BUFFER,PARSER dataProc
    class TYPE_CHECK,LOG_CMD,JSON_CMD cmdDispatch
    class TC_MODULE,LOG_SYSTEM,ERROR_LOG outputInteg
    class SHELL,LNS,MONITOR external
    class ENABLE,CONFIG,INTEGRATION config 