# LoRaWAN基站系统架构图表

本目录包含LoRaWAN基站系统的各种架构图和流程图，用于帮助理解系统的设计和运行机制。

## 目录结构

```
docs/diagrams/
├── sys_linux/                         # Linux系统接口相关图表
│   ├── system-architecture.mmd        # 系统整体架构图(已创建)
│   ├── process-startup-flow.mmd       # 进程启动流程图(已创建)
│   ├── process-management.mmd         # 进程管理机制图(已创建)
│   ├── eui-management.mmd             # EUI管理机制图(已创建)
│   ├── firmware-update.mmd            # 固件更新流程图(已创建)
│   ├── system-services.mmd            # 系统服务架构图(已创建)
│   ├── complete-startup-flow.mmd      # 完整系统启动流程图(已创建)
│   └── command-line-processing.mmd    # 命令行参数处理流程图(已创建)
├── tc/                                # TC传输控制器相关图表
│   ├── tc-architecture.mmd            # TC模块架构图(已创建)
│   ├── tc-connection-flow.mmd         # TC连接建立流程图(已创建)
│   ├── tc-state-machine.mmd           # TC状态机转换图(已创建)
│   ├── tc-reconnect-strategy.mmd      # TC重连策略流程图(已创建)
│   └── tc-summary.md                  # TC模块技术文档(已创建)
├── s2/                                # S2配置和协议模块相关图表
│   ├── s2-architecture.mmd            # S2整体架构图(已创建)
│   ├── configuration-flow.mmd         # 配置系统流程图(已创建)
│   ├── s2e-packet-flow.mmd            # S2E数据包处理流程图(已创建)
│   └── s2e-txqueue-management.mmd     # S2E发送队列管理流程图(已创建)
├── s2e/                               # S2E协议模块相关图表
│   ├── s2e-architecture.mmd           # S2E协议整体架构图(已创建)
│   ├── rx-processing-flow.mmd         # 接收数据处理流程图(已创建)
│   ├── airtime-calculation.mmd        # 空中时间计算流程图(已创建)
│   ├── duty-cycle-control.mmd         # 占空比控制机制图(已创建)
│   ├── alternative-time-algorithm.mmd # 备选时间算法图(已创建)
│   └── annotation-status.md           # S2E模块注释状态报告(已创建)
├── aio/                               # AIO异步IO系统相关图表
│   ├── aio-architecture.mmd           # AIO系统整体架构图(已创建)
│   ├── aio-event-loop-flow.mmd        # 事件循环处理流程图(已创建)
│   ├── aio-callback-lifecycle.mmd     # 回调函数生命周期图(已创建)
│   └── aio-timer-integration.mmd      # 定时器集成机制图(已创建)
├── xq/                                # XQ扩展队列系统相关图表
│   ├── xq-architecture.mmd            # XQ队列系统整体架构图(已创建)
│   ├── txq-lifecycle-flow.mmd         # TXQ发送队列生命周期流程图(已创建)
│   ├── rxq-management-flow.mmd        # RXQ接收队列管理流程图(已创建)
│   └── memory-compaction-mechanism.mmd # 内存紧凑化机制详图(已创建)
├── web/                               # Web服务器模块相关图表
│   ├── web-architecture.mmd           # Web服务器系统架构图(已创建)
│   ├── http-request-processing-flow.mmd # HTTP请求处理流程图(已创建)
│   └── web-lifecycle-states.mmd       # Web服务生命周期状态图(已创建)
├── tls/                               # TLS安全层模块相关图表
│   ├── tls-architecture.mmd           # TLS安全层架构图(已创建)
│   └── certificate-management-flow.mmd # 证书管理流程图(已创建)
├── fs/                                # FS文件系统模拟模块相关图表
│   ├── fs-architecture.mmd            # 文件系统模拟整体架构图(已创建)
│   ├── gc-mechanism-flow.mmd          # 垃圾回收机制详细流程图(已创建)
│   ├── file-operations-lifecycle.mmd  # 文件操作生命周期状态图(已创建)
│   └── storage-layout-diagram.mmd     # Flash存储布局示意图(已创建)
├── lora/                              # LoRa物理层协议模块相关图表
│   ├── lora-architecture.mmd          # LoRa协议解析系统架构图(已创建)
│   ├── frame-parsing-flow.mmd         # LoRaWAN帧解析详细流程图(已创建)
│   ├── frame-format-structure.mmd     # LoRaWAN帧格式结构详细图(已创建)
│   └── device-filtering-mechanism.mmd # 设备过滤机制流程图(已创建)
├── gps/                                # GPS时间同步和定位模块图表
│   ├── gps-architecture.mmd           # GPS系统架构图(已创建)
│   ├── nmea-parsing-flow.mmd          # NMEA协议解析流程图(已创建)
│   ├── device-connection-management.mmd # 设备连接管理流程图(已创建)
│   └── event-notification-system.mmd  # 事件通知系统图(已创建)
├── lgwsim/                            # LoRa网关仿真器模块图表
│   ├── lgwsim-architecture.mmd        # LoRa网关仿真器系统架构图(已创建)
│   ├── packet-flow.mmd                # 数据包收发处理流程图(已创建)
│   ├── cca-mechanism.mmd              # CCA信道评估机制图(已创建)
│   └── buffer-management.mmd          # 环形缓冲区管理机制图(已创建)
├── cmdfifo/                           # 命令FIFO模块图表
│   ├── cmdfifo-architecture.mmd       # 命令FIFO系统架构图(已创建)
│   ├── command-processing-flow.mmd    # 命令处理流程图(已创建)
│   └── fifo-connection-management.mmd # FIFO连接管理机制图(已创建)
├── web_linux/                         # Web平台实现模块图表
│   ├── platform-architecture.mmd      # Web平台实现架构图(已创建)
│   ├── config-api-flow.mmd            # 配置API处理流程图(已创建)
│   └── json-response-structure.mmd    # JSON响应结构图(已创建)
├── rmtsh/                             # 远程Shell模块图表
│   ├── rmtsh-architecture.mmd         # 远程Shell系统架构图(已创建)
│   ├── session-lifecycle.mmd          # 会话生命周期流程图(已创建)
│   ├── pty-management.mmd             # 伪终端管理机制图(已创建)
│   └── buffer-management.mmd          # 缓冲区管理机制图(已创建)
├── README.md                          # 本文件
├── log/                               # 日志系统相关图表
│   ├── log-architecture.mmd           # 日志系统架构图(已创建)
│   ├── logging-flow.mmd               # 日志处理流程图(已创建)
│   ├── thread-sync.mmd                # 多线程同步机制图(已创建)
│   └── log-summary.md                 # 日志系统技术文档(已创建)
└── [其他模块]/                        # 其他模块的图表目录
```

## 图表说明

### sys_linux模块图表

#### 1. 系统整体架构图 (system-architecture.mmd)
- **用途**: 展示整个Linux系统接口的模块组织结构
- **覆盖范围**: sys_linux.c中的主要函数和模块
- **关键特点**: 
  - 显示主入口函数sys_main的调用关系
  - 展示配置解析、进程管理、服务启动的层次结构
  - 包含EUI管理、固件更新、系统服务等子系统
- **适用场景**: 理解系统整体架构和模块间关系

#### 2. 进程启动流程图 (process-startup-flow.mmd)
- **用途**: 详细展示基站进程的启动和管理流程
- **覆盖范围**: 从sys_main到各种服务启动的完整流程
- **关键特点**:
  - 区分守护进程模式和普通模式的不同启动路径
  - 展示父子进程的创建和监控机制
  - 包含服务初始化的详细步骤
- **适用场景**: 调试启动问题和理解进程管理机制

#### 3. EUI管理机制图 (eui-management.mmd)
- **用途**: 展示EUI(Extended Unique Identifier)的查找、解析和设置流程
- **覆盖范围**: findDefaultEui、parseEui、setEui等函数
- **关键特点**: 
  - 显示从网络接口获取MAC地址的过程
  - 展示EUI格式验证和转换逻辑
  - 包含配置文件和命令行参数的处理
  - 显示接口优先级选择算法(eth接口优先)
- **适用场景**: 理解基站身份标识的管理机制

#### 4. 固件更新流程图 (firmware-update.mmd)
- **用途**: 展示固件更新的完整流程
- **覆盖范围**: sys_updateStart到sys_runUpdate的整个更新过程
- **关键特点**:
  - 显示临时文件的创建和管理
  - 展示更新数据的写入和验证过程
  - 包含更新提交和执行的安全机制
  - 展示启动时自动检查和执行更新的机制
- **适用场景**: 理解远程固件更新的实现机制

#### 5. 进程管理机制图 (process-management.mmd)
- **用途**: 详细展示进程管理的完整机制和流程
- **覆盖范围**: PID文件管理、进程终止、守护进程监控等功能
- **关键特点**:
  - 展示旧进程清理和新进程启动的完整流程
  - 显示守护进程的工作进程监控和自动重启机制
  - 包含PID文件管理和进程查找功能
  - 展示信号处理和进程终止的安全机制
- **适用场景**: 理解基站的进程管理和高可用性机制

#### 6. 系统服务架构图 (system-services.mmd)
- **用途**: 展示系统各层服务的组织结构和依赖关系
- **覆盖范围**: 从系统初始化到各种服务启动的完整架构
- **关键特点**:
  - 分层显示系统初始化、运行时、进程管理、服务启动等层次
  - 展示底层系统服务(时间、随机数、进程、固件更新)
  - 包含配置管理和事件循环机制
  - 使用颜色区分不同类型的服务模块
- **适用场景**: 理解整个系统的服务架构和模块依赖关系

#### 7. 完整系统启动流程图 (complete-startup-flow.mmd)
- **用途**: 展示从程序启动到所有服务运行的完整启动流程
- **覆盖范围**:
  - 程序入口和参数解析 (sys_main函数完整流程)
  - 配置处理和验证 (多源配置优先级处理)
  - 进程模式选择 (守护进程、主进程、从进程)
  - 系统核心初始化 (IO、日志、运行时、时间同步)
  - 服务启动阶段 (TC、CUPS、Web、GPS等服务)
  - 进程监控和重启机制
- **关键特点**:
  - 完整的启动时序，包含所有分支路径
  - 详细的配置处理优先级 (命令行 > 环境变量 > 配置文件 > 默认值)
  - 守护进程模式的完整实现 (fork + setsid + 监控)
  - 主从进程架构的启动流程
  - 错误处理和异常退出路径
- **适用场景**: 理解程序完整启动过程，调试启动问题，了解配置加载顺序

#### 8. 命令行参数处理流程图 (command-line-processing.mmd)
- **用途**: 详细展示命令行参数解析的完整流程和所有支持的选项
- **覆盖范围**:
  - argp参数解析框架的使用 (parse_opt回调函数)
  - 所有命令行选项的分类和处理 (配置、模式、特殊、系统选项)
  - 隐藏选项的功能 (模拟文件系统、自测试、主从进程)
  - 参数验证和错误处理机制
  - 选项优先级和配置应用流程
- **关键特点**:
  - 按功能分类的选项组织 (配置选项、运行模式、特殊操作等)
  - 详细的参数解析逻辑 (十六进制密钥解析、版本输出等)
  - 完整的错误处理路径 (未知选项、参数验证失败)
  - 隐藏选项的内部机制 (开发和测试功能)
  - 与后续配置处理阶段的衔接
- **适用场景**: 理解命令行接口设计，添加新的命令行选项，调试参数解析问题

### S2E协议模块图表

#### 9. S2E协议整体架构图 (s2e/s2e-architecture.mmd)
- **用途**: 展示Station-to-Server协议的完整架构和数据流
- **覆盖范围**:
  - 接收(RX)处理流程 (从无线电层到LNS的完整路径)
  - 发送(TX)处理流程 (从LNS到无线电层的调度机制)
  - 消息处理和协议分发 (router_config, dnframe, dnmsg等)
  - 占空比控制和功率管理
  - 时间同步和信道管理
- **关键特点**:
  - 双向数据流的完整展示
  - 核心函数的调用关系
  - 辅助模块的协作机制
  - 配置和状态管理
- **适用场景**: 理解S2E协议整体设计，分析数据流路径，调试协议问题

#### 10. 接收数据处理流程图 (s2e/rx-processing-flow.mmd)
- **用途**: 详细展示上行数据包的接收和处理流程
- **覆盖范围**:
  - 镜像帧检测算法 (相邻频率反射信号处理)
  - 信号质量评估 (8*SNR-RSSI指标)
  - 接收队列管理 (RXQ数据结构和操作)
  - JSON编码和WebSocket传输
  - 时间同步和参考时间计算
- **关键特点**:
  - 智能的重复帧检测和处理
  - 详细的数据结构说明
  - 完整的错误处理流程
  - 高精度的时间同步机制
- **适用场景**: 理解接收数据处理逻辑，调试镜像帧问题，优化信号质量

#### 11. 空中时间计算流程图 (s2e/airtime-calculation.mmd)
- **用途**: 展示LoRa数据包空中传输时间的精确计算算法
- **覆盖范围**:
  - LoRa物理层时间计算 (符合LoRa规范的完整算法)
  - FSK调制时间计算 (50kbps FSK的简化算法)
  - 参数优化和防溢出处理
  - 上行/下行时间计算的差异
- **关键特点**:
  - 严格按照LoRa物理层规范实现
  - 支持多种调制方式和参数组合
  - 高精度的微秒级计算
  - 性能优化的算法实现
- **适用场景**: 理解LoRa物理层原理，调试时间计算问题，优化占空比控制

#### 12. 占空比控制机制图 (s2e/duty-cycle-control.mmd) 🆕
- **用途**: 详细展示EU868频段的占空比控制机制和管理流程
- **覆盖范围**:
  - EU868频段的三级占空比限制 (0.1%/1%/10%)
  - 频段级和信道级占空比管理
  - 阻塞时间计算和状态更新流程
  - 备选天线和时间的处理策略
- **关键特点**:
  - 完整的频率到频段映射算法
  - 双层占空比控制机制 (频段+信道)
  - 精确的阻塞时间计算公式
  - 特殊状态处理 (禁用/永久阻塞)
- **适用场景**: 理解欧洲监管要求，调试占空比问题，优化发送调度

#### 13. 备选时间算法图 (s2e/alternative-time-algorithm.mmd) 🆕
- **用途**: 展示LoRaWAN三种设备类型的备选发送时间处理策略
- **覆盖范围**:
  - Class A设备的RX1→RX2窗口切换机制
  - Class B设备的固定ping时隙处理
  - Class C设备的灵活退避重试算法
  - 时间同步和参数更新流程
- **关键特点**:
  - 完整支持LoRaWAN设备分类标准
  - 详细的时间窗口管理机制
  - 智能的重试和退避策略
  - 精确的时间同步检查
- **适用场景**: 理解LoRaWAN协议实现，调试设备通信问题，优化网络性能

### LoRa网关仿真器模块图表 🆕

#### LoRa网关仿真器系统架构图 (lgwsim/lgwsim-architecture.mmd)
- **用途**: 展示LoRa网关仿真器的完整系统架构和核心组件
- **覆盖范围**:
  - API兼容层 (LGW1/LGW2双API支持，libloragw和sx1301ar接口)
  - 核心仿真引擎 (时间戳管理、空中时间计算、信道评估)
  - 通信子系统 (Unix域套接字、异步IO、连接管理)
  - 数据缓冲系统 (环形缓冲区、索引管理、溢出处理)
  - 配置系统 (硬件配置模拟、参数设置、初始化管理)
  - 外部系统接口 (仿真服务器、环境变量、BasicStation应用)
- **关键特点**:
  - 双API兼容设计，同时支持libloragw(LGW1)和sx1301ar(LGW2)硬件接口
  - 基于Unix域套接字的仿真通信架构
  - 高性能环形缓冲区实现，支持1000个数据包缓存
  - 精确的LoRa空中时间计算和CCA信道评估
  - 完整的硬件配置仿真和参数管理
- **适用场景**: 理解LoRa网关仿真器整体架构，分析仿真机制，扩展仿真功能

#### 数据包收发处理流程图 (lgwsim/packet-flow.mmd)
- **用途**: 详细展示仿真器中数据包的发送、接收、状态查询和应用读取流程
- **覆盖范围**:
  - 数据包发送流程 (CCA信道评估、时间窗计算、参数设置、套接字发送)
  - 数据包接收流程 (套接字读取、缓冲区管理、索引更新、CCA消息检测)
  - 状态查询流程 (时间戳获取、发送阶段判断、状态返回)
  - 应用读取流程 (数据包复制、索引管理、计数返回)
- **关键特点**:
  - 完整的数据包生命周期管理
  - 精确的发送状态跟踪(TX_SCHEDULED/TX_EMITTING/TX_FREE)
  - 智能的CCA信道评估机制
  - 高效的环形缓冲区数据流转
  - 统一的错误处理和连接恢复
- **适用场景**: 理解数据包处理机制，调试发送接收问题，优化数据流性能

#### CCA信道评估机制图 (lgwsim/cca-mechanism.mmd)
- **用途**: 展示Clear Channel Assessment信道评估的详细算法和管理机制
- **覆盖范围**:
  - CCA信息管理 (CCA消息结构、信息条目、魔数检测)
  - 信道评估算法 (频率匹配、时间冲突检测、循环遍历)
  - CCA信息更新 (消息接收、信息提取、状态更新)
  - 发送时机决策 (请求处理、时间窗计算、结果判断)
  - 时间轴示例 (占用时段、空闲区域、冲突检测、成功发送)
  - 外部仿真环境 (仿真服务器、干扰源、CCA信息生成)
- **关键特点**:
  - 完整的CCA信道评估算法实现
  - 精确的频率时间冲突检测机制
  - 实时的信道状态更新和管理
  - 智能的发送时机决策策略
  - 可视化的时间轴冲突示例
- **适用场景**: 理解CCA算法原理，调试信道冲突问题，优化发送调度策略

#### 环形缓冲区管理机制图 (lgwsim/buffer-management.mmd)
- **用途**: 详细展示环形缓冲区的存储结构、索引管理和操作流程
- **覆盖范围**:
  - 缓冲区结构 (数据包容量、大小计算、内存布局)
  - 索引管理 (读写索引、丢弃计数器、环形特性)
  - 空间计算宏 (可用空间、已用空间、数学算法)
  - 写入操作流程 (位置计算、空间检查、溢出处理、索引更新)
  - 读取操作流程 (数据检查、包复制、索引管理、计数返回)
  - 环形缓冲区状态示例 (正常写入、环形回绕、接近满、溢出处理)
  - CCA消息特殊处理 (检测、提取、跳过机制)
  - 内存布局示意 (对齐要求、环形特性、包结构)
- **关键特点**:
  - 高效的环形缓冲区设计，支持1000个数据包
  - 智能的溢出处理机制，保证系统稳定性
  - 字节级精确的索引管理和空间计算
  - 特殊的CCA消息处理，不影响正常数据流
  - 完整的内存对齐和性能优化策略
- **适用场景**: 理解缓冲区管理原理，调试内存使用问题，优化数据存储性能

### 命令FIFO模块图表 🆕

#### 命令FIFO系统架构图 (cmdfifo/cmdfifo-architecture.mmd)
- **用途**: 展示命令FIFO的完整系统架构和组件关系
- **覆盖范围**:
  - 外部命令输入层 (命令行客户端、命名管道文件、管道操作)
  - FIFO管理层 (连接管理、重连定时器、资源清理)
  - 数据处理层 (异步IO处理、缓冲区管理、命令解析器)
  - 命令分发层 (类型检查、日志命令处理、JSON命令处理)
  - 输出集成层 (TC传输模块、日志系统、错误处理)
  - 外部系统接口 (Shell环境、LNS服务器、监控系统)
  - 配置与初始化 (功能启用、系统配置、模块集成)
- **关键特点**:
  - 基于命名管道的多客户端命令输入架构
  - 事件驱动的异步处理机制，支持非阻塞操作
  - 智能的FIFO状态检测和自动重连机制
  - 双格式命令支持：文本命令(日志级别控制)和JSON命令(LNS转发)
  - 与TC模块完整集成，支持WebSocket消息转发
  - 完善的错误处理和资源清理机制
- **适用场景**: 理解外部命令接口设计，分析进程间通信机制，扩展命令处理功能

#### 命令处理流程图 (cmdfifo/command-processing-flow.mmd)
- **用途**: 详细展示从FIFO读取到命令执行的完整处理流程
- **覆盖范围**:
  - FIFO连接建立 (系统启动、路径保存、定时器初始化、首次连接)
  - FIFO状态检查与打开 (现有连接检查、文件状态验证、类型检查、AIO创建)
  - 数据读取与缓冲 (AIO读取事件、读取循环、错误处理、缓冲区更新)
  - 命令行解析 (解析循环、换行符检测、字符串终止、长度计算)
  - 命令类型识别 (JSON格式检查、文本命令分支、JSON命令分支)
  - 文本命令处理 (日志级别解析、级别设置、未知命令处理)
  - JSON命令处理 (TC状态检查、发送缓冲区管理、WebSocket转发)
  - 缓冲区管理 (错误记录、剩余数据处理、索引重置)
  - 错误处理与重连 (连接关闭、重连触发、定时重试)
- **关键特点**:
  - 完整的命令处理生命周期展示
  - 详细的错误处理和恢复机制
  - 智能的缓冲区管理和数据重组
  - 双分支命令处理：日志控制和JSON转发
  - 自动重连机制确保服务连续性
- **适用场景**: 理解命令处理机制，调试数据解析问题，优化处理性能

#### FIFO连接管理机制图 (cmdfifo/fifo-connection-management.mmd)
- **用途**: 展示FIFO连接的状态管理、重连策略和生命周期
- **覆盖范围**:
  - 连接状态 (断开状态、连接中状态、已连接状态、错误状态)
  - 重连机制 (定时器初始化、立即重连、定时重连、重连间隔)
  - 文件状态检查 (文件存在性、FIFO类型验证、权限检查)
  - 文件描述符管理 (打开标志、成功检查、错误处理)
  - AIO对象管理 (对象创建、上下文设置、回调注册、退出清理)
  - 连接生命周期事件 (启动事件、EOF事件、错误事件、退出事件)
  - 特殊处理机制 (立即读取、旧连接关闭、错误恢复)
- **关键特点**:
  - 完整的连接状态机设计
  - 智能的重连策略和错误恢复机制
  - 详细的文件状态检查和类型验证
  - 健壮的文件描述符和AIO对象管理
  - 全面的生命周期事件处理
  - 自动化的资源清理和状态重置
- **适用场景**: 理解连接管理设计，调试连接问题，优化重连策略

### S2配置和协议模块图表

#### 14. S2整体架构图 (s2/s2-architecture.mmd) 🆕
- **用途**: 展示S2配置系统和S2E协议引擎的完整架构关系
- **覆盖范围**:
  - S2配置系统的参数管理机制 (s2conf.c的完整功能)
  - S2E协议引擎的核心组件 (接收/发送队列、定时器、消息处理)
  - 区域特定功能的实现 (占空比控制、功率管理)
  - 配置参数与协议引擎的数据流关系
- **关键特点**:
  - 分层展示配置管理和协议处理的架构
  - 完整的参数解析和类型转换流程
  - 消息处理和协议分发机制
  - 区域监管要求的模块化实现

### web_linux模块图表

#### 1. Web平台实现架构图 (platform-architecture.mmd)
- **用途**: 展示Linux平台Web扩展层的完整架构和模块关系
- **覆盖范围**: web_linux.c与通用Web服务的集成架构
- **关键特点**:
  - 清晰展示通用Web层与平台特定层的分离
  - SYS_HANDLERS和AUTH_HANDLERS的路由机制
  - 配置管理API的处理流程
  - 预留认证系统的扩展架构
- **适用场景**: 理解Web服务的分层设计，了解平台适配机制

#### 2. 配置API处理流程图 (config-api-flow.mmd)
- **用途**: 详细展示配置API从HTTP请求到JSON响应的完整处理流程
- **覆盖范围**: handle_config_GET函数的完整执行过程
- **关键特点**:
  - 完整的HTTP请求解析和路由匹配流程
  - 详细的JSON编码过程和配置数据遍历
  - 错误处理和状态码返回机制
  - HTTP响应构建和客户端通信
- **适用场景**: 理解API处理细节，调试配置接口问题，优化响应性能

#### 3. JSON响应结构图 (json-response-structure.mmd)
- **用途**: 展示配置API返回的JSON数据结构和字段说明
- **覆盖范围**: 配置参数的JSON格式和字段含义
- **关键特点**:
  - 详细的JSON数据结构层次
  - 配置参数的四个核心字段说明
  - 配置来源类型的完整分类
  - 实际JSON响应示例展示
- **适用场景**: 理解API数据格式，开发客户端应用，设计管理界面

### rmtsh模块图表

#### 1. 远程Shell系统架构图 (rmtsh-architecture.mmd)
- **用途**: 展示远程Shell的完整系统架构和组件关系
- **覆盖范围**: 从客户端到Shell进程的完整数据流和控制流
- **关键特点**:
  - 多层次架构设计：客户端层→网络层→消息处理层→会话管理层→伪终端层→进程管理层
  - 双向数据流：JSON控制消息和二进制数据流的分离处理
  - 完整的生命周期管理：从会话创建到资源清理的全过程
  - 异步IO和缓冲区管理的集成设计
- **适用场景**: 理解远程Shell的整体架构，设计相似的远程管理系统

#### 2. 会话生命周期流程图 (session-lifecycle.mmd)
- **用途**: 详细展示远程Shell会话从创建到销毁的完整生命周期
- **覆盖范围**: startRmtsh和stopRmtsh函数的完整执行流程
- **关键特点**:
  - 详细的伪终端创建过程：posix_openpt→grantpt→unlockpt→open
  - 完整的子进程设置：环境变量→终端配置→stdio重定向→会话管理
  - 运行时监控和错误处理：数据流处理、状态监控、终止条件检测
  - 资源清理的安全机制：进程组终止、IO关闭、状态重置
- **适用场景**: 调试会话创建问题，优化资源管理，理解进程生命周期

#### 3. 伪终端管理机制图 (pty-management.mmd)
- **用途**: 深入展示PTY伪终端的创建、配置和数据流处理机制
- **覆盖范围**: PTY创建、配置、数据传输的完整技术细节
- **关键特点**:
  - PTY创建的每个步骤：权限设置、解锁、设备文件操作
  - 终端配置的技术细节：RAW模式、控制终端、会话管理
  - 双向数据流的异步处理：上行和下行的独立缓冲和流控
  - 错误监控和异常处理：设备错误、进程状态、缓冲区保护
- **适用场景**: 理解伪终端技术，解决终端兼容性问题，优化数据传输性能

#### 4. 缓冲区管理机制图 (buffer-management.mmd)
- **用途**: 详细展示上行和下行缓冲区的智能管理和压缩算法
- **覆盖范围**: 缓冲区设计、数据流控、压缩机制的完整实现
- **关键特点**:
  - 双缓冲区设计：上行(upbuf)和下行(dnbuf)的独立管理
  - 智能压缩算法：基于水位线的动态压缩和空间回收
  - 多层流控制：缓冲区级别、网络级别、进程级别的流控机制
  - 溢出保护和错误恢复：安全的内存管理和异常处理
- **适用场景**: 优化缓冲区性能，解决内存使用问题，设计流控制算法
- **适用场景**: 理解S2系统整体设计，分析配置与协议的交互关系

#### 15. 配置系统流程图 (s2/configuration-flow.mmd) 🆕
- **用途**: 详细展示S2配置系统的初始化和参数设置的完整流程
- **覆盖范围**:
  - 配置系统初始化的完整过程 (s2conf_ini函数流程)
  - 多源配置的优先级处理 (内置→环境变量→配置文件→命令行)
  - 各种数据类型的解析机制 (bool, u4, str, tspan, size)
  - JSON解码和参数验证流程
  - 错误处理和内存管理机制
- **关键特点**:
  - 完整的配置优先级链处理
  - 类型安全的参数解析流程
  - 详细的错误处理和恢复机制
  - 高效的内存管理策略
- **适用场景**: 理解配置系统设计，调试配置解析问题，添加新的配置参数

#### 16. S2E数据包处理流程图 (s2/s2e-packet-flow.mmd) 🆕
- **用途**: 展示S2E协议的上行接收和下行发送的完整数据包处理流程
- **覆盖范围**:
  - 上行数据包接收和处理 (从无线电层到LNS的完整路径)
  - 镜像帧检测和信号质量评估算法
  - 下行数据包调度和发送管理 (从LNS到无线电层)
  - 占空比控制和备选时间处理
  - 定时器管理和错误处理机制
- **关键特点**:
  - 双向数据流的详细处理步骤
  - 智能的重复帧检测算法
  - 完整的占空比监管实现
  - 灵活的备选方案处理机制
- **适用场景**: 理解数据包处理逻辑，调试通信问题，优化协议性能

#### 17. S2E发送队列管理流程图 (s2/s2e-txqueue-management.mmd) 🆕
- **用途**: 详细展示S2E发送队列的复杂调度和管理机制
- **覆盖范围**:
  - 发送任务添加流程 (s2e_addTxjob函数的完整逻辑)
  - 发送状态机处理 (s2e_nextTxAction函数的状态管理)
  - 备选天线和时间的处理策略
  - 占空比检查和冲突解决机制
  - 定时器管理和队列维护流程
- **关键特点**:
  - 完整的发送任务生命周期管理
  - 智能的冲突检测和解决算法
  - 多层次的备选方案处理机制
  - 精确的定时器控制和状态转换
  - 高效的队列排序和插入算法
- **适用场景**: 理解复杂的发送调度逻辑，调试发送队列问题，优化发送性能

#### 18. S2消息分发流程图 (s2/s2-message-dispatch.mmd) ⭐新增
- **用途**: 展示从LNS接收JSON消息到具体处理函数的完整分发流程
- **覆盖范围**:
  - JSON消息解码和类型识别 (s2e_onMsg函数的完整流程)
  - 10种不同消息类型的分发路径 (router_config, dnmsg, dnsched等)
  - 每种消息的具体处理逻辑和参数解析
  - 完整的错误处理机制 (解析失败、配置检查、参数验证)
  - 部分消息类型的响应生成和发送流程
- **关键特点**:
  - 完整的消息处理生命周期展示
  - 详细的消息类型分发逻辑
  - 全面的错误处理和恢复机制
  - 清晰的控制流和数据流路径
  - 包含配置验证和状态检查流程
- **适用场景**: 理解LNS通信协议完整实现，调试消息处理问题，扩展新的消息类型

### AIO异步IO系统模块图表 🆕

#### 26. AIO系统架构图 (aio/aio-architecture.mmd)
- **用途**: 展示AIO异步IO系统的整体架构和组件关系
- **覆盖范围**:
  - 事件循环核心 (基于select的IO多路复用)
  - 定时器管理 (高精度定时器队列和触发机制)
  - 回调管理 (注册、执行、清理的完整生命周期)
  - 文件描述符管理 (读写事件监听和状态跟踪)
- **关键特点**:
  - 单线程异步编程模型设计
  - 统一的事件处理架构
  - 高效的定时器集成机制
  - 完整的资源管理和错误处理
- **适用场景**: 理解异步IO设计原理，调试事件处理问题，扩展新的异步操作

#### 27. 事件循环流程图 (aio/aio-event-loop-flow.mmd)
- **用途**: 详细展示AIO事件循环的完整执行流程
- **覆盖范围**:
  - 初始化阶段 (FD集合初始化、定时器队列准备)
  - select等待阶段 (超时计算、事件监听、信号处理)
  - 事件处理阶段 (读写事件分发、回调执行、错误处理)
  - 定时器处理阶段 (到期检查、回调触发、队列更新)
- **关键特点**:
  - 完整的事件循环时序
  - 详细的超时计算算法
  - 统一的错误处理机制
  - 高精度的定时器处理
- **适用场景**: 理解事件循环机制，调试性能问题，优化响应时间

#### 28. 回调生命周期图 (aio/aio-callback-lifecycle.mmd)
- **用途**: 展示AIO回调函数的完整生命周期管理
- **覆盖范围**:
  - 回调注册 (读写回调、定时器回调、错误回调)
  - 回调执行 (参数传递、返回值处理、异常捕获)
  - 回调清理 (资源释放、内存管理、状态重置)
  - 动态管理 (添加、删除、修改回调配置)
- **关键特点**:
  - 完整的回调状态转换
  - 详细的资源管理流程
  - 统一的错误处理策略
  - 灵活的动态配置机制
- **适用场景**: 理解回调管理机制，调试内存泄漏问题，扩展回调功能

#### 29. 定时器集成机制图 (aio/aio-timer-integration.mmd)
- **用途**: 详细展示定时器与事件循环的集成机制
- **覆盖范围**:
  - 定时器队列管理 (最小堆结构、优先级排序)
  - 超时计算算法 (绝对时间、相对时间、精度控制)
  - 定时器触发机制 (到期检查、回调执行、队列维护)
  - 高精度时间同步 (系统时间、单调时间、性能优化)
- **关键特点**:
  - 高效的定时器队列实现
  - 精确的超时计算算法
  - 统一的时间管理机制
  - 优化的性能特征
- **适用场景**: 理解定时器实现原理，调试时间精度问题，优化定时器性能

### XQ扩展队列系统模块图表 🆕

#### 30. XQ队列系统架构图 (xq/xq-architecture.mmd)
- **用途**: 展示XQ扩展队列系统的整体架构和组件关系
- **覆盖范围**:
  - TXQ发送队列系统 (作业管理、数据缓冲、空闲链表、内存紧凑化)
  - RXQ接收队列系统 (作业队列、数据缓冲、队列指针、智能压缩)
  - 双队列协作机制 (数据流转、状态同步、资源共享)
  - 外部接口层 (应用API、系统集成、错误处理)
- **关键特点**:
  - 数据分离存储设计
  - 智能内存管理机制
  - 高性能的链表操作
  - 完整的队列管理接口
- **适用场景**: 理解队列系统设计，分析数据流转路径，优化内存使用

#### 31. TXQ生命周期流程图 (xq/txq-lifecycle-flow.mmd)
- **用途**: 详细展示TXQ发送作业的完整生命周期
- **覆盖范围**:
  - 系统初始化 (空闲链表建立、指针初始化、状态设置)
  - 作业创建 (空间分配、数据预留、状态标记)
  - 数据管理 (数据写入、提交确认、完整性检查)
  - 作业使用 (遍历访问、状态查询、数据读取)
  - 完成释放 (内存释放、紧凑化触发、链表维护)
- **关键特点**:
  - 完整的作业状态转换
  - 详细的内存管理流程
  - 即时紧凑化机制
  - 高效的链表操作
- **适用场景**: 理解TXQ设计原理，调试内存管理问题，优化发送性能

#### 32. RXQ管理流程图 (xq/rxq-management-flow.mmd)
- **用途**: 展示RXQ接收队列的智能管理流程
- **覆盖范围**:
  - 队列状态检查 (空状态判断、容量评估、空间管理)
  - 作业空间管理 (分配策略、压缩触发、空间回收)
  - 数据缓冲管理 (容量检查、智能压缩、布局优化)
  - 队列操作流程 (作业提交、队列消费、删除操作)
- **关键特点**:
  - 智能的空间管理策略
  - 双层压缩机制设计
  - 完整的队列操作支持
  - 高效的内存布局优化
- **适用场景**: 理解RXQ管理机制，调试队列状态问题，优化接收性能

#### 33. 内存紧凑化机制图 (xq/memory-compaction-mechanism.mmd)
- **用途**: 详细展示内存紧凑化的实现机制和策略差异
- **覆盖范围**:
  - TXQ即时紧凑化 (立即压缩、偏移调整、指针更新)
  - RXQ智能压缩 (条件触发、批量操作、性能优化)
  - 压缩算法实现 (内存移动、空洞填补、布局重组)
  - 性能特征对比 (时间复杂度、空间效率、适用场景)
- **关键特点**:
  - 差异化的压缩策略
  - 详细的算法实现
  - 完整的性能分析
  - 实用的应用指导
- **适用场景**: 理解内存管理算法，调试内存碎片问题，选择最优策略

### Web服务器模块图表 🆕

#### 34. Web服务器架构图 (web/web-architecture.mmd)
- **用途**: 展示BasicStation Web服务器的整体架构设计
- **覆盖范围**:
  - HTTP服务器核心 (连接管理、请求解析、响应生成)
  - 事件驱动架构 (AIO集成、异步处理、回调管理)
  - 智能路由系统 (CRC哈希路由、O(1)匹配、动态配置)
  - 内容服务系统 (静态文件、动态API、错误处理)
- **关键特点**:
  - 轻量级HTTP实现
  - 高性能路由算法
  - 统一的内容服务架构
  - 完整的错误处理机制
- **适用场景**: 理解Web服务器设计，分析HTTP处理流程，扩展新的服务功能

#### 35. HTTP请求处理流程图 (web/http-request-processing-flow.mmd)
- **用途**: 详细展示HTTP请求的完整处理流程
- **覆盖范围**:
  - 连接建立 (TCP连接、HTTP握手、状态初始化)
  - 请求解析 (HTTP头解析、方法识别、参数提取)
  - 路由匹配 (CRC计算、哈希查找、处理器选择)
  - 内容处理 (静态文件服务、动态API调用、响应生成)
  - 连接管理 (Keep-Alive、连接复用、超时处理)
- **关键特点**:
  - 完整的HTTP协议支持
  - 高效的请求处理流程
  - 灵活的内容处理机制
  - 优化的连接管理策略
- **适用场景**: 理解HTTP处理机制，调试请求处理问题，优化服务性能

#### 36. Web生命周期状态图 (web/web-lifecycle-states.mmd)
- **用途**: 展示Web服务器的完整生命周期状态转换
- **覆盖范围**:
  - 服务初始化 (配置加载、端口绑定、服务启动)
  - 运行状态管理 (连接处理、请求响应、状态监控)
  - 连接生命周期 (建立、处理、保持、关闭)
  - 服务终止 (优雅关闭、资源清理、状态重置)
- **关键特点**:
  - 完整的状态转换图
  - 详细的生命周期管理
  - 统一的错误处理策略
  - 优雅的服务控制机制
- **适用场景**: 理解服务状态管理，调试服务启停问题，实现服务监控

### TLS安全层模块图表 🆕

#### 37. TLS安全层架构图 (tls/tls-architecture.mmd)
- **用途**: 展示BasicStation TLS安全层的整体架构设计
- **覆盖范围**:
  - TLS配置管理系统 (证书配置、密钥管理、协议设置)
  - 证书验证系统 (证书链验证、CRL检查、信任管理)
  - 安全会话管理 (握手协商、会话复用、状态维护)
  - 加密通信接口 (数据加密、完整性保护、错误处理)
- **关键特点**:
  - 基于mbedTLS的轻量级实现
  - 完整的证书管理功能
  - 灵活的配置系统设计
  - 统一的安全策略管理
- **适用场景**: 理解TLS安全架构，配置证书管理，调试安全连接问题

#### 38. 证书管理流程图 (tls/certificate-management-flow.mmd)
- **用途**: 详细展示证书管理的完整流程和验证机制
- **覆盖范围**:
  - 证书加载 (文件读取、格式解析、内容验证)
  - 证书链验证 (路径构建、签名验证、有效期检查)
  - 证书吊销检查 (CRL下载、OCSP查询、状态缓存)
  - 信任存储管理 (CA证书、中间证书、客户端证书)
- **关键特点**:
  - 完整的证书验证流程
  - 详细的安全检查机制
  - 灵活的信任策略配置
  - 高效的缓存管理策略
- **适用场景**: 理解证书验证机制，配置安全策略，调试认证问题

### FS文件系统模拟模块图表 🆕

#### 39. 文件系统架构图 (fs/fs-architecture.mmd)
- **用途**: 展示BasicStation文件系统模拟的整体架构设计
- **覆盖范围**:
  - POSIX接口层 (文件操作API、工具接口、管理接口)
  - 文件系统核心层 (记录管理、句柄管理、查找索引)
  - 存储管理层 (垃圾回收、双分区管理)
  - Flash抽象层 (加密保护、访问接口)
  - 硬件抽象层 (系统Flash接口、指针访问)
- **关键特点**:
  - 基于Flash的日志结构化设计
  - 完整的POSIX兼容接口
  - 智能的垃圾回收机制
  - 安全的数据加密保护
- **适用场景**: 理解文件系统设计，分析存储架构，扩展文件操作功能

#### 40. 垃圾回收机制图 (fs/gc-mechanism-flow.mmd)
- **用途**: 详细展示文件系统垃圾回收的完整流程和算法
- **覆盖范围**:
  - 触发条件检查 (空间不足、inode耗尽、手动触发)
  - 扫描阶段处理 (记录遍历、缓存管理、溢出处理)
  - 复制阶段操作 (活跃文件复制、数据迁移、句柄修复)
  - 完成阶段清理 (分区擦除、状态切换、句柄恢复)
- **关键特点**:
  - Copy-GC算法实现
  - 智能的缓存批处理机制
  - 完整的数据迁移流程
  - 安全的状态切换机制
- **适用场景**: 理解GC算法原理，调试空间回收问题，优化GC性能

#### 41. 文件操作生命周期图 (fs/file-operations-lifecycle.mmd)
- **用途**: 展示文件操作的完整生命周期状态转换
- **覆盖范围**:
  - 文件系统就绪状态 (初始化、查找、创建、打开)
  - 文件已打开状态 (读取、写入、定位操作)
  - 文件管理操作 (删除、重命名、状态查询)
  - 垃圾回收状态 (空间回收、数据迁移)
- **关键特点**:
  - 完整的操作状态转换
  - 详细的错误处理路径
  - 统一的操作接口设计
  - 安全的并发控制机制
- **适用场景**: 理解文件操作流程，调试操作状态问题，实现操作监控

#### 42. 存储布局示意图 (fs/storage-layout-diagram.mmd)
- **用途**: 详细展示Flash存储的物理布局和记录格式设计
- **覆盖范围**:
  - Flash物理布局 (分区配置、双分区架构、地址映射)
  - 记录格式设计 (通用结构、FILE/DATA/RENAME/DELETE格式)
  - 数据加密保护 (密钥管理、地址映射、XOR加密)
  - 日志结构化特性 (追加写入、正向/逆向扫描)
  - 垃圾回收布局 (分区切换、写指针管理)
- **关键特点**:
  - 详细的存储布局设计
  - 完整的记录格式定义
  - 安全的数据保护机制
  - 高效的日志结构化实现
- **适用场景**: 理解存储布局设计，分析数据格式，调试存储问题

### LoRa物理层协议模块图表 🆕

#### 31. LoRa协议解析系统架构图 (lora/lora-architecture.mmd)
- **用途**: 展示LoRaWAN物理层协议解析的完整架构和数据流
- **覆盖范围**:
  - 协议解析的分层架构 (输入层、识别层、处理层、过滤层、输出层)
  - 帧类型分支处理 (Join帧、Data帧、Proprietary帧、Join Accept帧)
  - 设备过滤系统 (JoinEUI过滤器、NetID过滤器)
  - 输出格式化层 (JSON编码、日志输出)
  - 信标生成系统 (GPS时间、地理坐标、CRC计算)
- **关键特点**:
  - 完整的协议解析流水线展示
  - 分层架构的清晰可视化
  - 数据流和控制流的双向展示
  - 颜色区分不同功能层次
- **适用场景**: 理解LoRaWAN协议解析架构，分析数据流向，协议开发参考

#### 32. LoRaWAN帧解析详细流程图 (lora/frame-parsing-flow.mmd)
- **用途**: 详细展示从原始帧数据到JSON输出的完整解析流程
- **覆盖范围**:
  - 帧长度和格式校验 (空帧检查、协议版本验证、预留位检查)
  - 帧类型识别和分支 (MHDR字段解析、帧类型提取)
  - Join帧处理流程 (固定长度检查、字段提取、JoinEUI过滤)
  - Data帧处理流程 (可变长度处理、NetID过滤、字段提取)
  - 信标生成流程 (GPS时间处理、地理坐标转换、CRC计算)
- **关键特点**:
  - 完整的错误处理路径
  - 详细的过滤逻辑展示
  - 分支处理的时序控制
  - 成功和失败的明确区分
- **适用场景**: 理解帧解析逻辑，调试解析错误，优化解析性能

#### 33. LoRaWAN帧格式结构详细图 (lora/frame-format-structure.mmd)
- **用途**: 详细展示LoRaWAN各种帧类型的二进制格式和字段定义
- **覆盖范围**:
  - MHDR字段结构 (帧类型、预留位、协议版本的位布局)
  - Join Request帧格式 (23字节固定格式、字段偏移量)
  - Data帧格式 (可变长度格式、FCtrl字段结构、DevAddr结构)
  - 信标帧格式 (GPS时间、地理坐标、CRC校验的布局)
  - 过滤器数据结构 (JoinEUI范围数组、NetID位掩码数组)
- **关键特点**:
  - 精确的字节级别格式定义
  - 详细的位字段分解说明
  - 小端序存储格式的明确标注
  - 完整的偏移量和长度信息
- **适用场景**: 理解LoRaWAN帧格式，实现协议解析，调试帧结构问题

#### 34. 设备过滤机制流程图 (lora/device-filtering-mechanism.mmd)
- **用途**: 详细展示LoRaWAN设备的智能过滤机制和算法实现
- **覆盖范围**:
  - JoinEUI过滤器详细流程 (范围数组遍历、边界检查算法)
  - NetID过滤器详细流程 (位掩码计算、O(1)查找算法)
  - 过滤器配置结构 (数据格式、存储布局、默认配置)
  - 过滤决策和日志 (成功/失败路径、日志格式)
  - 性能优化特点 (算法复杂度、缓存友好性)
- **关键特点**:
  - 双层过滤架构的完整展示
  - 高效算法的详细实现逻辑
  - 配置灵活性和性能的平衡
  - 完整的错误处理和日志记录
- **适用场景**: 理解设备过滤算法，配置过滤规则，优化过滤性能

### TC传输控制器模块图表 🆕

#### 26. TC模块架构图 (tc/tc-architecture.mmd)
- **用途**: 展示TC传输控制器的整体架构和组件关系
- **覆盖范围**:
  - TC核心对象结构 (WebSocket连接、定时器、S2E上下文)
  - 连接管理层 (INFOS查询、MUXS连接、重连管理)
  - 状态机控制器和资源管理组件
  - 外部系统依赖 (系统服务、网络服务、协议层、运行时系统)
  - 远程服务接口 (INFOS、MUXS、CUPS服务)
- **关键特点**:
  - 分层架构设计清晰展示
  - 组件间依赖关系完整描述
  - 数据流和控制流的双向展示
  - 颜色区分不同类型的组件
- **适用场景**: 理解TC模块整体设计，分析组件依赖，架构优化

#### 27. TC连接建立流程图 (tc/tc-connection-flow.mmd)
- **用途**: 详细展示从TC启动到MUXS连接建立的完整流程
- **覆盖范围**:
  - INFOS服务发现阶段 (URI解析、连接建立、查询响应)
  - MUXS连接建立阶段 (URI解析、TLS设置、版本协商)
  - 错误处理和重连机制 (统一错误处理、重连策略选择)
  - 成功路径的完整展示 (从初始化到数据传输)
- **关键特点**:
  - 完整的连接时序图
  - 详细的错误分支处理
  - TLS安全连接的特殊处理
  - JSON消息格式和验证逻辑
- **适用场景**: 理解连接建立过程，调试连接问题，优化连接性能

#### 28. TC状态机转换图 (tc/tc-state-machine.mmd)
- **用途**: 展示TC模块所有状态之间的转换关系和触发条件
- **覆盖范围**:
  - 正常状态转换 (初始化→INFOS查询→MUXS连接→数据传输)
  - 错误状态处理 (超时、失败、拒绝、关闭等)
  - 退避状态机制 (INFOS退避、MUXS退避)
  - 终止和重启逻辑 (CUPS触发、系统停止)
- **关键特点**:
  - 完整的状态定义和枚举
  - 状态转换的触发条件说明
  - 退避重连的状态流转
  - 各状态的功能注释说明
- **适用场景**: 理解状态机设计，调试状态转换问题，添加新状态

#### 29. TC重连策略流程图 (tc/tc-reconnect-strategy.mmd)
- **用途**: 详细展示TC模块的智能重连策略和退避算法
- **覆盖范围**:
  - 错误类型分析和处理策略 (配置问题、连接关闭、连接失败)
  - MUXS快速重连机制 (指数退避、URI保持、状态保持)
  - INFOS重连退避机制 (线性退避、对象重建、状态清理)
  - CUPS触发条件和配置更新流程
- **关键特点**:
  - 双层重连策略 (快速重连+退避重连)
  - 详细的退避时间算法 (指数+线性)
  - 错误类型的智能识别和分流
  - 完整的重试次数控制机制
- **适用场景**: 理解重连算法设计，调试网络中断问题，优化重连性能

#### 30. TC模块技术文档 (tc/tc-summary.md)
- **用途**: TC模块的综合技术文档和开发指南
- **覆盖范围**:
  - 模块概述和核心功能说明
  - 关键数据结构和接口定义
  - 连接流程和重连策略详解
  - S2E协议接口和错误处理机制
  - 系统集成、性能特点、调试监控
  - 设计原则和常见问题处理
- **关键特点**:
  - 10000+字的详细技术文档
  - 完整的代码示例和配置说明
  - 深入的设计原理分析
  - 实用的问题排查指南
- **适用场景**: 深入学习TC模块，开发维护参考，问题诊断指南

## 技术规范

### Mermaid语法标准
- 所有图表使用Mermaid语法编写
- 确保在GitHub等平台能正确渲染
- 使用中文注释说明关键步骤

### 命名规范
- 文件名使用小写字母和连字符
- 图表节点包含具体函数名
- 使用不同颜色区分不同类型的操作

### 更新维护
- 代码变更时同步更新相关图表
- 定期检查图表的准确性和完整性
- 保持图表与代码实现的一致性

## 使用指南

1. **查看图表**: 使用支持Mermaid的工具查看.mmd文件
2. **理解系统**: 从系统架构图开始，逐步深入具体流程
3. **调试问题**: 结合流程图定位问题发生的环节
4. **代码开发**: 参考图表理解现有设计，避免破坏架构

## 相关资源

- [Mermaid官方文档](https://mermaid-js.github.io/mermaid/)
- [基站代码文档](../../README.md)
- [系统配置说明](../config/README.md) 

# BasicStation 技术图表目录

本目录包含 BasicStation 项目各模块的详细技术图表和架构设计文档。

## 图表组织结构

### AIO 异步IO系统 (`aio/`)
- **aio-architecture.mmd**: AIO系统整体架构图
- **aio-event-loop-flow.mmd**: 事件循环处理流程图  
- **aio-callback-lifecycle.mmd**: 回调函数生命周期图
- **aio-timer-integration.mmd**: 定时器集成机制图

### XQ 扩展队列系统 (`xq/`)
- **xq-architecture.mmd**: XQ队列系统整体架构图
- **txq-lifecycle-flow.mmd**: TXQ发送队列生命周期流程图
- **rxq-management-flow.mmd**: RXQ接收队列管理流程图
- **memory-compaction-mechanism.mmd**: 内存紧凑化机制详图

### Web服务器模块 (`web/`)
- **web-architecture.mmd**: Web服务器系统架构图
- **http-request-processing-flow.mmd**: HTTP请求处理流程图
- **web-lifecycle-states.mmd**: Web服务生命周期状态图

### TLS安全层模块 (`tls/`)
- **tls-architecture.mmd**: TLS安全层架构图
- **certificate-management-flow.mmd**: 证书管理流程图

### FS文件系统模拟模块 (`fs/`)
- **fs-architecture.mmd**: 文件系统模拟整体架构图
- **gc-mechanism-flow.mmd**: 垃圾回收机制详细流程图
- **file-operations-lifecycle.mmd**: 文件操作生命周期状态图  
- **storage-layout-diagram.mmd**: Flash存储布局示意图

### LoRa物理层协议模块 (`lora/`)
- **lora-architecture.mmd**: LoRa协议解析系统架构图
- **frame-parsing-flow.mmd**: LoRaWAN帧解析详细流程图
- **frame-format-structure.mmd**: LoRaWAN帧格式结构详细图
- **device-filtering-mechanism.mmd**: 设备过滤机制流程图

### GPS时间同步和定位模块 (`gps/`)
- **gps-architecture.mmd**: GPS系统整体架构图
- **nmea-parsing-flow.mmd**: NMEA协议解析流程图
- **device-connection-management.mmd**: 设备连接管理流程图
- **event-notification-system.mmd**: 事件通知系统图

## 各模块技术特点

### AIO异步IO系统
- 基于select的单线程异步编程模型
- 统一的IO事件和定时器处理
- 高效的回调管理和资源清理
- 为网络通信和进程管理提供基础设施

### XQ扩展队列系统  
- 双队列设计：TXQ发送队列 + RXQ接收队列
- 智能内存管理：即时紧凑化 + 智能压缩
- 数据分离存储：作业管理与数据缓冲独立
- 高性能的链表操作和索引转换

### Web服务器模块
- 轻量级HTTP服务实现
- 事件驱动的异步处理架构  
- CRC哈希路由系统，O(1)路由匹配
- 静态文件服务和动态API支持

### TLS安全层模块
- 基于mbedTLS的轻量级安全实现
- 双向认证和证书链验证
- 统一的错误处理和日志记录
- 灵活的配置系统支持多种部署场景

### FS文件系统模拟模块
- 基于Flash的日志结构化文件系统
- Copy-GC垃圾回收算法，双分区轮换  
- 位置相关XOR数据加密保护
- POSIX兼容的文件操作接口
- CRC校验确保数据完整性

### LoRa物理层协议模块
- 严格按照LoRaWAN 1.0.x规范实现的协议解析
- 支持所有LoRaWAN帧类型：Join、Data、Beacon、Proprietary
- 智能设备过滤：JoinEUI范围过滤 + NetID位掩码过滤
- 高性能JSON编码器：直接二进制到JSON的零拷贝转换
- Class B信标生成：GPS时间同步 + 地理坐标编码
- CRC-16-CCITT校验算法：无查表实现节省内存

### GPS时间同步和定位模块
- NMEA 0183协议和UBX二进制协议双重支持
- 支持TTY串口和FIFO管道两种接口方式
- 智能重连机制：TTY和FIFO不同重连策略，指数退避算法
- 位置变化检测：高精度坐标比较，0.001度变化阈值
- 事件驱动通知：FIX/NOFIX/MOVE三种事件类型，延迟报告机制
- 异步IO处理：基于AIO事件循环的非阻塞数据读取和解析

## 图表使用说明

1. **架构图**: 展示各模块的整体设计和组件关系
2. **流程图**: 详细描述关键操作的执行步骤
3. **状态图**: 说明系统或组件的状态变迁过程
4. **机制图**: 深入解析特定算法或机制的实现细节

## 图表渲染

所有图表使用 Mermaid 语法编写，可以通过以下方式查看：

1. **GitHub**: 直接在 GitHub 上查看 `.mmd` 文件
2. **VS Code**: 安装 Mermaid Preview 插件
3. **在线工具**: 使用 [Mermaid Live Editor](https://mermaid.live/)
4. **本地渲染**: 使用 mermaid-cli 工具

## 技术文档

每个模块的图表配套有详细的中文注释和技术说明，涵盖：

- 系统设计理念和架构原则
- 核心算法和数据结构实现
- 关键功能和性能优化技巧
- 错误处理和异常情况分析
- 与其他模块的接口和依赖关系

这些图表和文档为理解 BasicStation 的内部工作机制提供了全面的技术参考。