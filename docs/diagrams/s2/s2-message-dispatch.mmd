graph TD
    A["ğŸŒ LNSå‘é€JSONæ¶ˆæ¯"] --> B["ğŸ“¡ s2e_onMsg()"]
    B --> C["ğŸ” uj_iniDecoder()<br/>åˆå§‹åŒ–JSONè§£ç å™¨"]
    C --> D["ğŸ“‹ uj_msgtype()<br/>æå–æ¶ˆæ¯ç±»å‹"]
    D --> E["âœ… uj_decode()<br/>è§£ç JSONæ¶ˆæ¯"]
    E --> F{{"ğŸ”§ åŒºåŸŸé…ç½®æ£€æŸ¥<br/>s2ctx->region == 0?"}}
    
    F -->|"æ˜¯ä¸”ä¸ºä¸‹è¡Œæ¶ˆæ¯"| G["âš ï¸ ä¸¢å¼ƒæ—©æœŸæ¶ˆæ¯<br/>LOG(WARNING)"]
    F -->|"å¦æˆ–éä¸‹è¡Œæ¶ˆæ¯"| H["ğŸ“¨ æ¶ˆæ¯ç±»å‹åˆ†å‘"]
    G --> I["ğŸ”š è¿”å›æˆåŠŸ"]
    
    H --> J1["ğŸ”§ J_router_config<br/>handle_router_config()"]
    H --> J2["ğŸ“¤ J_dnframe<br/>handle_dnframe()"]
    H --> J3["ğŸ“¬ J_dnmsg<br/>handle_dnmsg()"]
    H --> J4["â° J_dnsched<br/>handle_dnsched()"]
    H --> J5["ğŸ• J_timesync<br/>handle_timesync()"]
    H --> J6["â±ï¸ J_getxtime<br/>handle_getxtime()"]
    H --> J7["ğŸ’» J_runcmd<br/>handle_runcmd()"]
    H --> J8["ğŸ–¥ï¸ J_rmtsh<br/>s2e_handleRmtsh()"]
    H --> J9["âŒ J_error<br/>é”™è¯¯æ¶ˆæ¯å¤„ç†"]
    H --> J10["ğŸ”Œ å¹³å°ç‰¹å®š<br/>s2e_handleCommands()"]
    
    J1 --> K1["ğŸ› ï¸ é…ç½®ç³»ç»Ÿå‚æ•°<br/>â€¢ åŒºåŸŸè®¾ç½®<br/>â€¢ ä¿¡é“é…ç½®<br/>â€¢ é¢‘ç‡è§„åˆ’"]
    J1 --> K1A["âœ… sys_inState(CONNECTED)"]
    
    J2 --> K2["ğŸ“Š ä¸‹è¡Œå¸§å¤„ç†(å·²è¿‡æ—¶)<br/>â€¢ è§£ædnframeæ ¼å¼<br/>â€¢ è½¬æ¢ä¸ºæ–°æ ¼å¼<br/>â€¢ è­¦å‘Šè¿‡æ—¶ä½¿ç”¨"]
    
    J3 --> K3["ğŸ“® ä¸‹è¡Œæ¶ˆæ¯å¤„ç†<br/>â€¢ Class A/B/Cè®¾å¤‡<br/>â€¢ æ¶ˆæ¯éªŒè¯<br/>â€¢ å‘é€é˜Ÿåˆ—æ·»åŠ "]
    
    J4 --> K4["ğŸ“… ç²¾ç¡®æ—¶é—´è°ƒåº¦<br/>â€¢ æ‰¹é‡å‘é€ä»»åŠ¡<br/>â€¢ GPSæ—¶é—´åŒæ­¥<br/>â€¢ é˜Ÿåˆ—ç®¡ç†"]
    
    J5 --> K5["â²ï¸ æ—¶é—´åŒæ­¥å¤„ç†<br/>â€¢ LNSæ—¶é—´åŸºå‡†<br/>â€¢ æœ¬åœ°æ—¶é—´å¯¹é½<br/>â€¢ æ‰©å±•æ—¶é—´è®¡ç®—"]
    
    J6 --> K6["ğŸ•°ï¸ æ—¶é—´æŸ¥è¯¢å“åº”<br/>â€¢ å½“å‰ç³»ç»Ÿæ—¶é—´<br/>â€¢ æ‰©å±•æ—¶é—´æ•°ç»„<br/>â€¢ UTCæ—¶é—´è½¬æ¢"]
    
    J7 --> K7["âš¡ è¿œç¨‹å‘½ä»¤æ‰§è¡Œ<br/>â€¢ å‚æ•°éªŒè¯<br/>â€¢ ç³»ç»Ÿå‘½ä»¤è°ƒç”¨<br/>â€¢ å®‰å…¨æ£€æŸ¥"]
    
    J8 --> K8["ğŸ’¾ è¿œç¨‹Shellå¤„ç†<br/>â€¢ äºŒè¿›åˆ¶æ•°æ®æµ<br/>â€¢ å‘½ä»¤è¡Œæ¥å£<br/>â€¢ å®æ—¶äº¤äº’"]
    
    J9 --> K9["ğŸš¨ é”™è¯¯æ¶ˆæ¯è®°å½•<br/>â€¢ LNSé”™è¯¯é€šçŸ¥<br/>â€¢ è­¦å‘Šæ—¥å¿—<br/>â€¢ çŠ¶æ€è¿½è¸ª"]
    
    J10 --> K10["ğŸ”§ å¹³å°å‘½ä»¤å¤„ç†<br/>â€¢ ç¡¬ä»¶ç‰¹å®šåŠŸèƒ½<br/>â€¢ é©±åŠ¨ç¨‹åºæ¥å£<br/>â€¢ ç³»ç»Ÿé›†æˆ"]
    
    K3 --> L1["ğŸ“‹ txq_reserveJob()<br/>é¢„ç•™å‘é€ä»»åŠ¡"]
    L1 --> L2["âš™ï¸ è§£ææ¶ˆæ¯å‚æ•°<br/>â€¢ diid, priority<br/>â€¢ DR, Freq<br/>â€¢ æ—¶é—´è®¾ç½®"]
    L2 --> L3["ğŸ¯ s2e_addTxjob()<br/>æ·»åŠ åˆ°å‘é€é˜Ÿåˆ—"]
    
    K4 --> M1["ğŸ“Š è§£æè°ƒåº¦æ•°ç»„<br/>schedule[]"]
    M1 --> M2["ğŸ”„ æ‰¹é‡å¤„ç†ä»»åŠ¡<br/>for each slot"]
    M2 --> M3["â° æ—¶é—´è½¬æ¢<br/>GPS/xtimeâ†’txtime"]
    M3 --> M4["ğŸ“¤ é˜Ÿåˆ—æäº¤<br/>txq_commitJob()"]
    
    K5 --> N1["ğŸ“¡ æå–æ—¶é—´å‚æ•°<br/>xtime, txtime, gpstime"]
    N1 --> N2["ğŸ”§ ts_setTimesyncLns()<br/>è®¾ç½®æ—¶é—´åŸºå‡†"]
    N2 --> N3["âš¡ ts_processTimesyncLns()<br/>å¤„ç†æ—¶é—´åŒæ­¥"]
    
    K6 --> O1["ğŸ“¤ æ„å»ºå“åº”æ¶ˆæ¯<br/>getxtime response"]
    O1 --> O2["ğŸ• æ”¶é›†æ—¶é—´ä¿¡æ¯<br/>ustime, UTCtime, xtimes"]
    O2 --> O3["ğŸ“¡ å‘é€å“åº”<br/>sendText()"]
    
    K7 --> P1["ğŸ“ è§£æå‘½ä»¤å‚æ•°<br/>command + arguments"]
    P1 --> P2["âœ… å‚æ•°éªŒè¯<br/>å‘½ä»¤å­˜åœ¨æ€§æ£€æŸ¥"]
    P2 --> P3["âš¡ sys_execCommand()<br/>å¼‚æ­¥æ‰§è¡Œå‘½ä»¤"]
    
    subgraph "ğŸ”§ é…ç½®å¤„ç†è¯¦æƒ…"
        K1 --> Q1["ğŸŒ åŒºåŸŸå‚æ•°è®¾ç½®<br/>EU868/US915/AS923"]
        Q1 --> Q2["ğŸ“» ä¿¡é“è®¡åˆ’é…ç½®<br/>ä¸Šè¡Œ/ä¸‹è¡Œé¢‘ç‡"]
        Q2 --> Q3["âš¡ åŠŸç‡é™åˆ¶è®¾ç½®<br/>EIRP/TXPower"]
        Q3 --> Q4["ğŸ“Š å ç©ºæ¯”å‚æ•°<br/>DCé™åˆ¶é…ç½®"]
    end
    
    subgraph "ğŸ“¤ å‘é€ä»»åŠ¡å¤„ç†"
        L3 --> R1["ğŸ¯ ä¼˜å…ˆçº§è®¡ç®—<br/>calcPriority()"]
        R1 --> R2["â° æ—¶é—´éªŒè¯<br/>earliest time check"]
        R2 --> R3["ğŸš¦ å ç©ºæ¯”æ£€æŸ¥<br/>EU868/PerChannel"]
        R3 --> R4["ğŸ”„ é˜Ÿåˆ—æ’å…¥<br/>æŒ‰æ—¶é—´æ’åº"]
    end
    
    subgraph "âš ï¸ é”™è¯¯å¤„ç†"
        E --> E1{{"âŒ è§£æå¤±è´¥?"}}
        E1 -->|"æ˜¯"| E2["ğŸ“ LOG(ERROR)<br/>è§£æå¤±è´¥æ¶ˆæ¯"]
        E2 --> I
        E1 -->|"å¦"| F
        
        J1 --> J1E{{"âŒ é…ç½®å¤±è´¥?"}}
        J1E -->|"æ˜¯"| J1F["ğŸš¨ é…ç½®é”™è¯¯<br/>è¿”å›å¤±è´¥"]
        J1E -->|"å¦"| K1A
    end
    
    classDef msgHandler fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef processing fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef validation fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef success fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    
    class J1,J2,J3,J4,J5,J6,J7,J8,J9,J10 msgHandler
    class K1,K2,K3,K4,K5,K6,K7,K8,K9,K10 processing
    class F,L2,M3,N1,P2 validation
    class G,E2,J1F error
    class I,K1A,O3,P3 success 