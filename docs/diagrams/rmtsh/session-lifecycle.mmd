flowchart TD
    Start([LNS发送rmtsh启动命令])
    
    subgraph "消息解析阶段"
        A1[接收JSON消息]
        A2[解析消息字段]
        A3[提取user、start、term参数]
        A4[验证会话索引范围]
    end
    
    subgraph "会话状态检查"
        B1{检查会话是否已启动?}
        B2[会话已运行，跳过启动]
        B3[会话空闲，准备启动]
    end
    
    subgraph "伪终端创建阶段"
        C1[posix_openpt创建PTY主端]
        C2[grantpt设置权限]
        C3[unlockpt解锁访问]
        C4[open PTY从端设备]
        C5{PTY创建是否成功?}
        C6[记录错误并返回]
    end
    
    subgraph "进程创建阶段"
        D1[fork创建子进程]
        D2{fork是否成功?}
        D3[记录fork错误]
    end
    
    subgraph "子进程Shell设置"
        E1[关闭PTY主端]
        E2[设置TERM环境变量]
        E3[获取终端设置tcgetattr]
        E4[配置RAW模式cfmakeraw]
        E5[应用设置tcsetattr]
        E6[重定向stdio到PTY从端]
        E7[创建新会话setsid]
        E8[设置控制终端TIOCSCTTY]
        E9[exec执行Shell程序]
        E10[Shell进程开始运行]
    end
    
    subgraph "父进程会话管理"
        F1[关闭PTY从端]
        F2[保存用户名和进程ID]
        F3[创建AIO对象]
        F4[注册up_read回调]
        F5[会话正式启动]
    end
    
    subgraph "运行时数据流处理"
        G1[上行：Shell输出→PTY主端]
        G2[up_read读取数据]
        G3[缓冲区管理和压缩]
        G4[WebSocket二进制传输]
        G5[下行：用户输入→s2e_onBinary]
        G6[dn_fill填入缓冲区]
        G7[dn_write写入PTY主端]
        G8[Shell接收用户命令]
    end
    
    subgraph "会话监控"
        H1[mtime活动时间更新]
        H2[进程状态检查]
        H3[缓冲区状态监控]
        H4[错误检测和处理]
    end
    
    subgraph "会话终止阶段"
        I1{触发终止条件?}
        I2[Shell进程退出EOF]
        I3[网络连接错误]
        I4[缓冲区溢出]
        I5[LNS发送stop命令]
        I6[stopRmtsh执行]
    end
    
    subgraph "资源清理阶段"
        J1[发送EOF到远程客户端]
        J2[kill进程组SIGKILL]
        J3[waitpid清理僵尸进程]
        J4[aio_close关闭异步IO]
        J5[重置缓冲区状态]
        J6[清空会话数据]
    end
    
    End([会话完全终止])
    
    %% 主流程连接
    Start --> A1
    A1 --> A2
    A2 --> A3
    A3 --> A4
    A4 --> B1
    
    B1 -->|是| B2
    B1 -->|否| B3
    B2 --> End
    B3 --> C1
    
    C1 --> C2
    C2 --> C3
    C3 --> C4
    C4 --> C5
    C5 -->|失败| C6
    C5 -->|成功| D1
    C6 --> End
    
    D1 --> D2
    D2 -->|失败| D3
    D2 -->|成功-子进程| E1
    D2 -->|成功-父进程| F1
    D3 --> End
    
    %% 子进程流程
    E1 --> E2
    E2 --> E3
    E3 --> E4
    E4 --> E5
    E5 --> E6
    E6 --> E7
    E7 --> E8
    E8 --> E9
    E9 --> E10
    
    %% 父进程流程
    F1 --> F2
    F2 --> F3
    F3 --> F4
    F4 --> F5
    
    %% 运行时流程
    F5 --> G1
    G1 --> G2
    G2 --> G3
    G3 --> G4
    G5 --> G6
    G6 --> G7
    G7 --> G8
    G8 --> G1
    
    %% 监控流程
    G2 --> H1
    G7 --> H1
    H1 --> H2
    H2 --> H3
    H3 --> H4
    
    %% 终止条件检查
    H4 --> I1
    I1 -->|Shell退出| I2
    I1 -->|网络错误| I3
    I1 -->|缓冲溢出| I4
    I1 -->|停止命令| I5
    I2 --> I6
    I3 --> I6
    I4 --> I6
    I5 --> I6
    
    %% 清理流程
    I6 --> J1
    J1 --> J2
    J2 --> J3
    J3 --> J4
    J4 --> J5
    J5 --> J6
    J6 --> End
    
    %% 样式定义
    classDef startEnd fill:#c8e6c9
    classDef parseStage fill:#e1f5fe
    classDef checkStage fill:#f3e5f5
    classDef ptyStage fill:#fff3e0
    classDef processStage fill:#e8f5e8
    classDef childStage fill:#fce4ec
    classDef parentStage fill:#f1f8e9
    classDef runtimeStage fill:#e0f2f1
    classDef monitorStage fill:#fff8e1
    classDef terminateStage fill:#ffebee
    classDef cleanupStage fill:#f9fbe7
    
    class Start,End startEnd
    class A1,A2,A3,A4 parseStage
    class B1,B2,B3 checkStage
    class C1,C2,C3,C4,C5,C6 ptyStage
    class D1,D2,D3 processStage
    class E1,E2,E3,E4,E5,E6,E7,E8,E9,E10 childStage
    class F1,F2,F3,F4,F5 parentStage
    class G1,G2,G3,G4,G5,G6,G7,G8 runtimeStage
    class H1,H2,H3,H4 monitorStage
    class I1,I2,I3,I4,I5,I6 terminateStage
    class J1,J2,J3,J4,J5,J6 cleanupStage 