graph TD
    A["sys_main 主函数启动"] --> B{"检查是否为守护进程模式"}
    B -->|是| C["设置守护进程日志文件"]
    B -->|否| O["直接启动主进程"]
    
    C --> D["fork() 创建子进程"]
    D --> E{"fork() 返回值检查"}
    E -->|失败| F["致命错误退出"]
    E -->|父进程| G["父进程代码块"]
    E -->|子进程| H["子进程代码块"]
    
    G --> I["记录子进程PID"]
    I --> J["写入PID文件"]
    J --> K["父进程退出"]
    
    H --> L["设置会话ID setsid()"]
    L --> M["初始化异步IO"]
    M --> N["初始化日志系统"]
    N --> P["初始化系统组件"]
    P --> Q["启动守护进程"]
    
    Q --> R["startupDaemon 启动"]
    R --> S["设置系统状态为死亡"]
    S --> T["刷新日志"]
    T --> U["再次fork() 创建工作进程"]
    
    U --> V{"fork() 返回值检查"}
    V -->|失败| W["守护进程fork失败"]
    V -->|子进程| X["工作进程代码"]
    V -->|父进程| Y["守护进程代码"]
    
    X --> Z["初始化工作进程日志"]
    Z --> AA["记录工作进程启动日志"]
    AA --> BB["启动主处理逻辑"]
    
    Y --> CC["保存工作进程ID"]
    CC --> DD["开始监控工作进程"]
    
    DD --> EE["waitForWorker 监控循环"]
    EE --> FF["非阻塞检查子进程状态"]
    FF --> GG{"工作进程状态检查"}
    GG -->|正常运行| HH["设置500ms定时器"]
    GG -->|已死亡| II["记录进程死亡日志"]
    
    HH --> EE
    II --> JJ["清除工作进程ID"]
    JJ --> KK["重新启动守护进程"]
    KK --> R
    
    BB --> LL["进入主事件循环 aio_loop()"]
    
    style A fill:#e1f5fe
    style R fill:#f3e5f5
    style EE fill:#fff3e0
    style LL fill:#e8f5e8