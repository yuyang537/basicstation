# LoRa Basics Station 系统架构和数据流图

## 系统总体架构图

```mermaid
graph TB
    subgraph "LoRa Basics Station 系统架构"
        subgraph "应用层 (Application Layer)"
            Main[main函数入口]
            SysMain[sys_main主函数]
            Daemon[守护进程管理]
        end

        subgraph "网络协议层 (Network Protocol Layer)"
            TC[TC引擎<br/>Traffic Concentrator]
            CUPS[CUPS客户端<br/>Configuration & Update]
            WebSock[WebSocket协议栈]
            HTTP[HTTP客户端]
            TLS[TLS/SSL安全层]
        end

        subgraph "系统服务层 (System Service Layer)"
            Logging[日志系统]
            Config[配置管理]
            Update[更新管理]
            TimeSync[时间同步]
            FileSystem[文件系统]
        end

        subgraph "运行时层 (Runtime Layer)"
            RT[运行时系统]
            AIO[异步IO系统]
            Timer[定时器系统]
            Memory[内存管理]
        end

        subgraph "硬件抽象层 (Hardware Abstraction Layer)"
            RAL[无线电抽象层]
            SX1301[SX1301驱动]
            SX1302[SX1302/Corecell驱动]
            PicoCell[PicoCell USB驱动]
            GPIO[GPIO控制]
        end

        subgraph "物理层 (Physical Layer)"
            LoRaRadio[LoRa无线电模块]
            GPS[GPS模块]
            LED[状态LED]
            SPI[SPI接口]
            USB[USB接口]
        end
    end

    subgraph "外部系统 (External Systems)"
        LNS[LoRaWAN<br/>Network Server]
        CUPSServer[CUPS<br/>Configuration Server]
        LoRaDevices[LoRa终端设备]
        NTPServer[NTP时间服务器]
    end

    %% 主要数据流连接
    Main --> SysMain
    SysMain --> Daemon
    SysMain --> TC
    SysMain --> CUPS
    
    TC --> WebSock
    CUPS --> HTTP
    WebSock --> TLS
    HTTP --> TLS
    
    TC --> LNS
    CUPS --> CUPSServer
    
    TC --> Config
    CUPS --> Config
    CUPS --> Update
    
    Config --> FileSystem
    Update --> FileSystem
    Logging --> FileSystem
    
    TC --> AIO
    CUPS --> AIO
    AIO --> RT
    
    TimeSync --> NTPServer
    TimeSync --> GPS
    
    RAL --> SX1301
    RAL --> SX1302
    RAL --> PicoCell
    
    SX1301 --> LoRaRadio
    SX1302 --> LoRaRadio
    PicoCell --> LoRaRadio
    
    LoRaRadio --> LoRaDevices
    
    GPIO --> LED
    SX1301 --> SPI
    SX1302 --> SPI
    PicoCell --> USB

    classDef appLayer fill:#e1f5fe
    classDef netLayer fill:#f3e5f5
    classDef sysLayer fill:#e8f5e8
    classDef rtLayer fill:#fff3e0
    classDef halLayer fill:#fce4ec
    classDef phyLayer fill:#f1f8e9
    classDef extSys fill:#fff8e1

    class Main,SysMain,Daemon appLayer
    class TC,CUPS,WebSock,HTTP,TLS netLayer
    class Logging,Config,Update,TimeSync,FileSystem sysLayer
    class RT,AIO,Timer,Memory rtLayer
    class RAL,SX1301,SX1302,PicoCell,GPIO halLayer
    class LoRaRadio,GPS,LED,SPI,USB phyLayer
    class LNS,CUPSServer,LoRaDevices,NTPServer extSys
```

## TC引擎状态机图

```mermaid
stateDiagram-v2
    [*] --> TC_INI : 初始化TC实例
    
    TC_INI --> TC_INFOS_REQ_PEND : tc_start()启动连接
    TC_INFOS_REQ_PEND --> TC_INFOS_GOT_URI : 成功获取MUXS URI
    TC_INFOS_REQ_PEND --> TC_ERR_FAILED : 连接失败
    TC_INFOS_REQ_PEND --> TC_ERR_TIMEOUT : 连接超时
    TC_INFOS_REQ_PEND --> TC_ERR_REJECTED : 被拒绝
    
    TC_INFOS_GOT_URI --> TC_MUXS_REQ_PEND : 连接MUXS
    TC_MUXS_REQ_PEND --> TC_MUXS_CONNECTED : 成功连接MUXS
    TC_MUXS_REQ_PEND --> TC_ERR_FAILED : MUXS连接失败
    TC_MUXS_REQ_PEND --> TC_ERR_TIMEOUT : MUXS连接超时
    
    TC_MUXS_CONNECTED --> TC_ERR_CLOSED : 连接关闭
    TC_MUXS_CONNECTED --> TC_ERR_FAILED : 连接错误
    
    TC_ERR_CLOSED --> TC_MUXS_BACKOFF : 重连退避
    TC_ERR_FAILED --> TC_INFOS_BACKOFF : INFOS重连退避
    TC_ERR_TIMEOUT --> TC_INFOS_BACKOFF : INFOS重连退避
    TC_ERR_REJECTED --> CUPS_Trigger : 触发CUPS重新配置
    
    TC_MUXS_BACKOFF --> TC_MUXS_REQ_PEND : 退避结束，重连MUXS
    TC_INFOS_BACKOFF --> TC_INFOS_REQ_PEND : 退避结束，重连INFOS
    
    CUPS_Trigger --> [*] : TC终止，启动CUPS
```

## CUPS协议状态机图

```mermaid
stateDiagram-v2
    [*] --> CUPS_INI : 初始化CUPS实例
    
    CUPS_INI --> CUPS_HTTP_REQ_PEND : cups_start()开始HTTP请求
    CUPS_HTTP_REQ_PEND --> CUPS_FEED_CUPS_CRED : HTTP连接成功，开始接收数据
    CUPS_HTTP_REQ_PEND --> CUPS_ERR_FAILED : HTTP连接失败
    CUPS_HTTP_REQ_PEND --> CUPS_ERR_TIMEOUT : HTTP连接超时
    CUPS_HTTP_REQ_PEND --> CUPS_ERR_REJECTED : HTTP请求被拒绝
    
    CUPS_FEED_CUPS_CRED --> CUPS_FEED_TC_CRED : CUPS凭证接收完成
    CUPS_FEED_TC_CRED --> CUPS_FEED_SIGNATURE : TC凭证接收完成
    CUPS_FEED_SIGNATURE --> CUPS_FEED_UPDATE : 签名接收完成
    CUPS_FEED_UPDATE --> CUPS_DONE : 更新数据接收完成
    
    CUPS_DONE --> ConfigUpdate : 应用配置更新
    CUPS_DONE --> FirmwareUpdate : 应用固件更新
    CUPS_DONE --> [*] : CUPS会话完成
    
    CUPS_ERR_FAILED --> Retry : 重试机制
    CUPS_ERR_TIMEOUT --> Retry : 重试机制
    CUPS_ERR_REJECTED --> CredRotate : 凭证轮换
    
    Retry --> CUPS_INI : 延迟后重试
    CredRotate --> CUPS_INI : 使用备用凭证重试
```

## 数据包流向图

```mermaid
sequenceDiagram
    participant Device as LoRa设备
    participant Radio as LoRa无线电
    participant RAL as 无线电抽象层
    participant S2E as S2E协议栈
    participant TC as TC引擎
    participant LNS as LNS服务器

    Note over Device,LNS: 上行数据包流程
    Device->>Radio: LoRa RF信号
    Radio->>RAL: 接收中断
    RAL->>S2E: rxpkt数据包
    S2E->>TC: JSON编码的uplink
    TC->>LNS: WebSocket发送

    Note over Device,LNS: 下行数据包流程  
    LNS->>TC: WebSocket downlink
    TC->>S2E: JSON解码
    S2E->>RAL: txpkt调度
    RAL->>Radio: 发送调度
    Radio->>Device: LoRa RF信号

    Note over Device,LNS: 时间同步流程
    LNS->>TC: 时间同步请求
    TC->>S2E: 处理时间请求
    S2E->>RAL: 获取精确时间戳
    RAL->>TC: 返回时间信息
    TC->>LNS: 时间同步响应
```

## 配置更新流程图

```mermaid
sequenceDiagram
    participant Station as Station
    participant CUPS as CUPS服务器
    participant FileSystem as 文件系统
    participant TC as TC引擎

    Note over Station,TC: CUPS配置更新流程
    Station->>CUPS: POST /update-info (网关信息)
    CUPS->>Station: HTTP响应 (分段数据)
    
    Station->>Station: 解析URI段
    Station->>FileSystem: 保存新的CUPS/TC URI
    
    Station->>Station: 接收凭证段
    Station->>FileSystem: 保存新的TLS凭证
    
    Station->>Station: 接收签名段
    Station->>Station: 验证数字签名
    
    Station->>Station: 接收更新段
    Station->>FileSystem: 写入固件更新文件
    
    Station->>Station: 应用配置更新
    Station->>TC: 重启TC引擎
    TC->>TC: 使用新配置连接LNS
```

## 模块依赖关系图

```mermaid
graph TD
    subgraph "核心模块依赖"
        sys[sys.c<br/>系统抽象层] --> rt[rt.c<br/>运行时系统]
        sys --> aio[aio.c<br/>异步IO]
        sys --> log[log.c<br/>日志系统]
        
        tc[tc.c<br/>TC引擎] --> sys
        tc --> ws[ws.c<br/>WebSocket]
        tc --> s2e[s2e.c<br/>S2E协议]
        
        cups[cups.c<br/>CUPS客户端] --> sys
        cups --> http[http.c<br/>HTTP客户端]
        cups --> net[net.c<br/>网络层]
        
        s2e --> ral[ral.c<br/>无线电抽象层]
        s2e --> lora[lora.c<br/>LoRa协议]
        s2e --> timesync[timesync.c<br/>时间同步]
        
        ral --> ral_lgw[ral_lgw.c<br/>SX1301驱动]
        ral --> ral_lgw2[ral_lgw2.c<br/>SX1302驱动]
        
        ws --> tls[tls.c<br/>TLS安全层]
        http --> tls
        net --> tls
        
        sys --> fs[fs.c<br/>文件系统]
        sys --> uj[uj.c<br/>JSON处理]
        
        rt --> aio
        timesync --> rt
        
        style sys fill:#ffeb3b
        style tc fill:#4caf50
        style cups fill:#2196f3
        style s2e fill:#ff9800
        style ral fill:#9c27b0
    end
```

## 关键配置文件结构

```mermaid
graph LR
    subgraph "配置文件层次"
        subgraph "REG (常规配置)"
            station_conf[station.conf<br/>主配置文件]
            tc_uri[tc.uri<br/>TC服务器地址]
            tc_cert[tc.cert<br/>TC TLS证书]
            tc_key[tc.key<br/>TC私钥]
            cups_uri[cups.uri<br/>CUPS服务器地址]
            cups_cert[cups.cert<br/>CUPS TLS证书]
            cups_key[cups.key<br/>CUPS私钥]
        end
        
        subgraph "BAK (备份配置)"
            station_conf_bak[station.conf<br/>备份配置]
            tc_uri_bak[tc.uri<br/>备份TC地址]
            tc_cert_bak[tc.cert<br/>备份TC证书]
            tc_key_bak[tc.key<br/>备份TC私钥]
            cups_uri_bak[cups.uri<br/>备份CUPS地址]
            cups_cert_bak[cups.cert<br/>备份CUPS证书]
            cups_key_bak[cups.key<br/>备份CUPS私钥]
        end
        
        subgraph "BOOT (启动配置)"
            cups_boot_cert[cups-boot.cert<br/>启动CUPS证书]
            cups_boot_key[cups-boot.key<br/>启动CUPS私钥]
            cups_boot_uri[cups-boot.uri<br/>启动CUPS地址]
        end
    end
    
    subgraph "配置轮换策略"
        Failure[连接失败] --> Check{失败次数>阈值?}
        Check -->|是| Rotate[轮换到下一配置集]
        Check -->|否| Retry[使用当前配置重试]
        Rotate --> REG{当前是REG?}
        REG -->|是| SwitchBAK[切换到BAK]
        REG -->|否| CheckBAK{当前是BAK?}
        CheckBAK -->|是| SwitchBOOT[切换到BOOT]
        CheckBAK -->|否| SwitchREG[切换到REG]
    end
```

这个架构图展示了LoRa Basics Station的完整系统设计，包括：

1. **分层架构**: 从应用层到物理层的清晰分层
2. **状态机**: TC和CUPS的详细状态转换
3. **数据流**: 上行和下行数据包的完整路径
4. **配置管理**: 多层配置文件和故障转移机制
5. **模块依赖**: 各模块间的依赖关系

这种设计确保了系统的高可靠性、可维护性和可扩展性。