# LoRa Basics Station 快速参考指南

## 🚀 快速启动

### 编译和运行
```bash
# 克隆代码库
git clone https://github.com/lorabasics/basicstation.git
cd basicstation

# 编译 (Raspberry Pi)
make platform=rpi variant=std

# 编译 (Corecell)
make platform=corecell variant=std

# 运行示例
cd examples/live-s2.sm.tc
RADIODEV=/dev/spidev0.0 ../../build-rpi-std/bin/station
```

## 📋 命令行选项参考

| 选项 | 长选项 | 参数 | 说明 |
|------|--------|------|------|
| `-d` | `--daemon` | - | 守护进程模式 |
| `-f` | `--force` | - | 强制接管已运行实例 |
| `-h` | `--home` | DIR | 配置文件主目录 |
| `-i` | `--radio-init` | cmd | 无线电初始化脚本 |
| `-k` | `--kill` | - | 终止运行中的进程 |
| `-l` | `--log-level` | LVL | 日志级别 (0-7) |
| `-L` | `--log-file` | FILE | 日志文件路径 |
| `-N` | `--no-tc` | - | 仅运行CUPS，不连接LNS |
| `-p` | `--params` | - | 打印当前参数设置 |
| `-t` | `--temp` | DIR | 临时文件目录 |
| `-x` | `--eui-prefix` | id6 | EUI前缀设置 |
| `-v` | `--version` | - | 显示版本信息 |

## 🔧 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `STATION_DIR` | 配置文件主目录 | 当前目录 |
| `STATION_TEMPDIR` | 临时文件目录 | `/tmp` |
| `STATION_LOGFILE` | 日志文件路径 | `stderr` |
| `STATION_LOGLEVEL` | 日志级别 | `INFO` |
| `STATION_RADIOINIT` | 无线电初始化命令 | - |
| `STATION_EUIPREFIX` | EUI前缀 | - |
| `RADIODEV` | 无线电设备路径 | 自动检测 |

## 📁 配置文件结构

### 主配置文件 (`station.conf`)
```json
{
    "SX1301_conf": {
        "lorawan_public": true,
        "clksrc": 1,
        "radio_0": {
            "enable": true,
            "freq": 867500000
        },
        "radio_1": {
            "enable": true,
            "freq": 868500000
        },
        "if_chains": [
            {"enable": true, "freq": -400000},
            {"enable": true, "freq": -200000},
            {"enable": true, "freq": 0},
            {"enable": true, "freq": 200000},
            {"enable": true, "freq": 400000}
        ]
    },
    "station_conf": {
        "routerid": "::1",
        "log_level": "INFO",
        "log_size": 10000000,
        "log_rotate": 3
    }
}
```

### 配置文件层次
```
~/
├── station.conf          # 主配置文件
├── tc.uri                # TC服务器URI
├── tc.cert               # TC TLS证书
├── tc.key                # TC私钥
├── cups.uri              # CUPS服务器URI  
├── cups.cert             # CUPS TLS证书
├── cups.key              # CUPS私钥
├── cups-boot.cert        # 启动CUPS证书
├── cups-boot.key         # 启动CUPS私钥
└── cups-boot.uri         # 启动CUPS URI
```

## 🔄 核心API参考

### TC引擎API
```c
// TC引擎生命周期
tc_t* tc_ini(tmrcb_t ondone);           // 初始化TC引擎
void tc_start(tc_t* tc);                // 启动TC连接
void tc_free(tc_t* tc);                 // 释放TC资源

// 系统级TC控制
void sys_iniTC();                       // 初始化TC系统
void sys_startTC();                     // 启动TC引擎
void sys_stopTC();                      // 停止TC引擎
s1_t sys_statusTC();                    // 获取TC状态
```

### CUPS API
```c
// CUPS生命周期
cups_t* cups_ini();                     // 初始化CUPS实例
void cups_start(cups_t* cups);          // 启动CUPS会话
void cups_free(cups_t* cups);           // 释放CUPS资源

// 系统级CUPS控制
void sys_iniCUPS();                     // 初始化CUPS系统
void sys_triggerCUPS(int delay);       // 触发CUPS会话
void sys_clearCUPS();                   // 清除CUPS定时器
void sys_delayCUPS();                   // 延迟CUPS交互
s1_t sys_statusCUPS();                  // 获取CUPS状态
```

### 系统服务API
```c
// 日志系统
void LOG(int mod_level, const char* fmt, ...);
void sys_iniLogging(struct logfile* lf, int captureStdio);

// 配置管理
str_t sys_uri(int credtype, int credset);
void sys_saveUri(int credtype, str_t uri);
u4_t sys_crcCred(int credtype, int credset);

// 更新管理
void sys_updateStart(int len);
void sys_updateWrite(u1_t* data, int off, int len);
int sys_updateCommit(int len);
void sys_runUpdate();
void sys_abortUpdate();
```

## 📊 状态码参考

### TC引擎状态
| 状态码 | 状态名 | 说明 |
|--------|--------|------|
| 0 | `TC_INI` | 初始状态 |
| 1 | `TC_INFOS_REQ_PEND` | INFOS请求等待中 |
| 2 | `TC_INFOS_GOT_URI` | 获得MUXS URI |
| 3 | `TC_MUXS_REQ_PEND` | MUXS连接等待中 |
| 4 | `TC_MUXS_CONNECTED` | 已连接到MUXS |
| -1 | `TC_ERR_TIMEOUT` | 超时错误 |
| -2 | `TC_ERR_FAILED` | 连接失败 |
| -3 | `TC_ERR_CLOSED` | 连接关闭 |
| -4 | `TC_ERR_REJECTED` | 连接被拒绝 |
| -5 | `TC_ERR_NOURI` | 无URI配置 |

### CUPS状态
| 状态码 | 状态名 | 说明 |
|--------|--------|------|
| 0 | `CUPS_INI` | 初始状态 |
| 1 | `CUPS_HTTP_REQ_PEND` | HTTP请求等待中 |
| 2-6 | `CUPS_FEED_*` | 数据接收状态 |
| 7 | `CUPS_DONE` | 完成状态 |
| -1 | `CUPS_ERR_TIMEOUT` | 超时错误 |
| -2 | `CUPS_ERR_FAILED` | 请求失败 |
| -3 | `CUPS_ERR_CLOSED` | 连接关闭 |
| -4 | `CUPS_ERR_REJECTED` | 请求被拒绝 |
| -5 | `CUPS_ERR_NOURI` | 无URI配置 |

## 🔍 故障排除指南

### 常见问题

#### 1. 无线电设备未找到
```bash
# 检查SPI设备
ls -la /dev/spidev*

# 检查USB设备
lsusb | grep -i lora

# 设置RADIODEV环境变量
export RADIODEV=/dev/spidev0.0
```

#### 2. 权限问题
```bash
# 添加用户到dialout组
sudo usermod -a -G dialout $USER

# 设置SPI权限
sudo chmod 666 /dev/spidev*
```

#### 3. 连接问题
```bash
# 检查网络连接
ping 8.8.8.8

# 检查DNS解析
nslookup lns.example.com

# 检查证书
openssl x509 -in tc.cert -text -noout
```

#### 4. 配置问题
```bash
# 验证JSON格式
cat station.conf | jq .

# 检查配置参数
./station --params

# 重置配置（使用备份）
cp station.conf.bak station.conf
```

### 日志分析

#### 日志级别
- `ERROR` (1): 错误信息
- `WARNING` (2): 警告信息  
- `NOTICE` (3): 重要通知
- `INFO` (4): 一般信息
- `DEBUG` (5): 调试信息
- `VERBOSE` (6): 详细信息
- `XDEBUG` (7): 极详细调试

#### 模块标识
- `MOD_SYS`: 系统模块
- `MOD_TCE`: TC引擎
- `MOD_CUP`: CUPS模块
- `MOD_S2E`: S2E协议
- `MOD_RAL`: 无线电抽象层

#### 典型日志模式
```
# 正常启动
[SYS:INFO] Starting station...
[TCE:INFO] Starting TC engine
[TCE:INFO] Connecting to INFOS: wss://lns.example.com
[TCE:VERBOSE] Connected to MUXS.

# 连接问题
[TCE:ERROR] TC connect failed - URI: wss://lns.example.com
[TCE:INFO] INFOS reconnect backoff 10s (retry 1)

# CUPS更新
[CUP:INFO] Starting a CUPS session now.
[CUP:INFO] CUPS provided TC updates (uri) - restarting TC engine
```

### 性能监控

#### 关键指标
```bash
# CPU使用率
top -p $(pidof station)

# 内存使用
cat /proc/$(pidof station)/status | grep -E "VmRSS|VmSize"

# 网络连接
netstat -tulpn | grep station

# 文件描述符
ls -la /proc/$(pidof station)/fd | wc -l
```

#### 统计信息
- 上行包计数：`rxnb`, `rxok`, `rxfw`
- 下行包计数：`txnb`, `txok`
- 错误计数：连接失败、超时、重试次数

## 🛠️ 开发调试

### 编译选项
```bash
# 调试版本
make platform=rpi variant=debug

# 启用详细日志
make platform=rpi variant=std CFLAGS=-DCFG_logfile_lvl=7

# 启用测试功能
make platform=rpi variant=std CFLAGS=-DCFG_selftests
```

### GDB调试
```bash
# 编译调试版本
make platform=rpi variant=debug

# 启动GDB
gdb ./build-rpi-debug/bin/station
(gdb) set args -l 7
(gdb) run
```

### 内存检查
```bash
# Valgrind检查
valgrind --leak-check=full ./build-rpi-debug/bin/station

# AddressSanitizer
make platform=rpi variant=std CFLAGS=-fsanitize=address
```

## 📚 参考链接

- [官方文档](https://doc.sm.tc/station)
- [GitHub仓库](https://github.com/lorabasics/basicstation)
- [LoRaWAN规范](https://lora-alliance.org/resource_hub/lorawan-specification-v1-1/)
- [Semtech SX130x文档](https://www.semtech.com/products/wireless-rf/lora-gateways)

## 🆘 获取帮助

- GitHub Issues: 报告bug和功能请求
- LoRa Developer Portal: 技术支持
- 社区论坛: 经验分享和讨论

---

*本指南涵盖了LoRa Basics Station的核心功能和常见操作。详细信息请参考官方文档和源代码注释。*