# LoRa Basics Station å¿«é€Ÿå‚è€ƒæŒ‡å—

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### ç¼–è¯‘å’Œè¿è¡Œ
```bash
# å…‹éš†ä»£ç åº“
git clone https://github.com/lorabasics/basicstation.git
cd basicstation

# ç¼–è¯‘ (Raspberry Pi)
make platform=rpi variant=std

# ç¼–è¯‘ (Corecell)
make platform=corecell variant=std

# è¿è¡Œç¤ºä¾‹
cd examples/live-s2.sm.tc
RADIODEV=/dev/spidev0.0 ../../build-rpi-std/bin/station
```

## ğŸ“‹ å‘½ä»¤è¡Œé€‰é¡¹å‚è€ƒ

| é€‰é¡¹ | é•¿é€‰é¡¹ | å‚æ•° | è¯´æ˜ |
|------|--------|------|------|
| `-d` | `--daemon` | - | å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ |
| `-f` | `--force` | - | å¼ºåˆ¶æ¥ç®¡å·²è¿è¡Œå®ä¾‹ |
| `-h` | `--home` | DIR | é…ç½®æ–‡ä»¶ä¸»ç›®å½• |
| `-i` | `--radio-init` | cmd | æ— çº¿ç”µåˆå§‹åŒ–è„šæœ¬ |
| `-k` | `--kill` | - | ç»ˆæ­¢è¿è¡Œä¸­çš„è¿›ç¨‹ |
| `-l` | `--log-level` | LVL | æ—¥å¿—çº§åˆ« (0-7) |
| `-L` | `--log-file` | FILE | æ—¥å¿—æ–‡ä»¶è·¯å¾„ |
| `-N` | `--no-tc` | - | ä»…è¿è¡ŒCUPSï¼Œä¸è¿æ¥LNS |
| `-p` | `--params` | - | æ‰“å°å½“å‰å‚æ•°è®¾ç½® |
| `-t` | `--temp` | DIR | ä¸´æ—¶æ–‡ä»¶ç›®å½• |
| `-x` | `--eui-prefix` | id6 | EUIå‰ç¼€è®¾ç½® |
| `-v` | `--version` | - | æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ |

## ğŸ”§ ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `STATION_DIR` | é…ç½®æ–‡ä»¶ä¸»ç›®å½• | å½“å‰ç›®å½• |
| `STATION_TEMPDIR` | ä¸´æ—¶æ–‡ä»¶ç›®å½• | `/tmp` |
| `STATION_LOGFILE` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | `stderr` |
| `STATION_LOGLEVEL` | æ—¥å¿—çº§åˆ« | `INFO` |
| `STATION_RADIOINIT` | æ— çº¿ç”µåˆå§‹åŒ–å‘½ä»¤ | - |
| `STATION_EUIPREFIX` | EUIå‰ç¼€ | - |
| `RADIODEV` | æ— çº¿ç”µè®¾å¤‡è·¯å¾„ | è‡ªåŠ¨æ£€æµ‹ |

## ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„

### ä¸»é…ç½®æ–‡ä»¶ (`station.conf`)
```json
{
    "SX1301_conf": {
        "lorawan_public": true,
        "clksrc": 1,
        "radio_0": {
            "enable": true,
            "freq": 867500000
        },
        "radio_1": {
            "enable": true,
            "freq": 868500000
        },
        "if_chains": [
            {"enable": true, "freq": -400000},
            {"enable": true, "freq": -200000},
            {"enable": true, "freq": 0},
            {"enable": true, "freq": 200000},
            {"enable": true, "freq": 400000}
        ]
    },
    "station_conf": {
        "routerid": "::1",
        "log_level": "INFO",
        "log_size": 10000000,
        "log_rotate": 3
    }
}
```

### é…ç½®æ–‡ä»¶å±‚æ¬¡
```
~/
â”œâ”€â”€ station.conf          # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ tc.uri                # TCæœåŠ¡å™¨URI
â”œâ”€â”€ tc.cert               # TC TLSè¯ä¹¦
â”œâ”€â”€ tc.key                # TCç§é’¥
â”œâ”€â”€ cups.uri              # CUPSæœåŠ¡å™¨URI  
â”œâ”€â”€ cups.cert             # CUPS TLSè¯ä¹¦
â”œâ”€â”€ cups.key              # CUPSç§é’¥
â”œâ”€â”€ cups-boot.cert        # å¯åŠ¨CUPSè¯ä¹¦
â”œâ”€â”€ cups-boot.key         # å¯åŠ¨CUPSç§é’¥
â””â”€â”€ cups-boot.uri         # å¯åŠ¨CUPS URI
```

## ğŸ”„ æ ¸å¿ƒAPIå‚è€ƒ

### TCå¼•æ“API
```c
// TCå¼•æ“ç”Ÿå‘½å‘¨æœŸ
tc_t* tc_ini(tmrcb_t ondone);           // åˆå§‹åŒ–TCå¼•æ“
void tc_start(tc_t* tc);                // å¯åŠ¨TCè¿æ¥
void tc_free(tc_t* tc);                 // é‡Šæ”¾TCèµ„æº

// ç³»ç»Ÿçº§TCæ§åˆ¶
void sys_iniTC();                       // åˆå§‹åŒ–TCç³»ç»Ÿ
void sys_startTC();                     // å¯åŠ¨TCå¼•æ“
void sys_stopTC();                      // åœæ­¢TCå¼•æ“
s1_t sys_statusTC();                    // è·å–TCçŠ¶æ€
```

### CUPS API
```c
// CUPSç”Ÿå‘½å‘¨æœŸ
cups_t* cups_ini();                     // åˆå§‹åŒ–CUPSå®ä¾‹
void cups_start(cups_t* cups);          // å¯åŠ¨CUPSä¼šè¯
void cups_free(cups_t* cups);           // é‡Šæ”¾CUPSèµ„æº

// ç³»ç»Ÿçº§CUPSæ§åˆ¶
void sys_iniCUPS();                     // åˆå§‹åŒ–CUPSç³»ç»Ÿ
void sys_triggerCUPS(int delay);       // è§¦å‘CUPSä¼šè¯
void sys_clearCUPS();                   // æ¸…é™¤CUPSå®šæ—¶å™¨
void sys_delayCUPS();                   // å»¶è¿ŸCUPSäº¤äº’
s1_t sys_statusCUPS();                  // è·å–CUPSçŠ¶æ€
```

### ç³»ç»ŸæœåŠ¡API
```c
// æ—¥å¿—ç³»ç»Ÿ
void LOG(int mod_level, const char* fmt, ...);
void sys_iniLogging(struct logfile* lf, int captureStdio);

// é…ç½®ç®¡ç†
str_t sys_uri(int credtype, int credset);
void sys_saveUri(int credtype, str_t uri);
u4_t sys_crcCred(int credtype, int credset);

// æ›´æ–°ç®¡ç†
void sys_updateStart(int len);
void sys_updateWrite(u1_t* data, int off, int len);
int sys_updateCommit(int len);
void sys_runUpdate();
void sys_abortUpdate();
```

## ğŸ“Š çŠ¶æ€ç å‚è€ƒ

### TCå¼•æ“çŠ¶æ€
| çŠ¶æ€ç  | çŠ¶æ€å | è¯´æ˜ |
|--------|--------|------|
| 0 | `TC_INI` | åˆå§‹çŠ¶æ€ |
| 1 | `TC_INFOS_REQ_PEND` | INFOSè¯·æ±‚ç­‰å¾…ä¸­ |
| 2 | `TC_INFOS_GOT_URI` | è·å¾—MUXS URI |
| 3 | `TC_MUXS_REQ_PEND` | MUXSè¿æ¥ç­‰å¾…ä¸­ |
| 4 | `TC_MUXS_CONNECTED` | å·²è¿æ¥åˆ°MUXS |
| -1 | `TC_ERR_TIMEOUT` | è¶…æ—¶é”™è¯¯ |
| -2 | `TC_ERR_FAILED` | è¿æ¥å¤±è´¥ |
| -3 | `TC_ERR_CLOSED` | è¿æ¥å…³é—­ |
| -4 | `TC_ERR_REJECTED` | è¿æ¥è¢«æ‹’ç» |
| -5 | `TC_ERR_NOURI` | æ— URIé…ç½® |

### CUPSçŠ¶æ€
| çŠ¶æ€ç  | çŠ¶æ€å | è¯´æ˜ |
|--------|--------|------|
| 0 | `CUPS_INI` | åˆå§‹çŠ¶æ€ |
| 1 | `CUPS_HTTP_REQ_PEND` | HTTPè¯·æ±‚ç­‰å¾…ä¸­ |
| 2-6 | `CUPS_FEED_*` | æ•°æ®æ¥æ”¶çŠ¶æ€ |
| 7 | `CUPS_DONE` | å®ŒæˆçŠ¶æ€ |
| -1 | `CUPS_ERR_TIMEOUT` | è¶…æ—¶é”™è¯¯ |
| -2 | `CUPS_ERR_FAILED` | è¯·æ±‚å¤±è´¥ |
| -3 | `CUPS_ERR_CLOSED` | è¿æ¥å…³é—­ |
| -4 | `CUPS_ERR_REJECTED` | è¯·æ±‚è¢«æ‹’ç» |
| -5 | `CUPS_ERR_NOURI` | æ— URIé…ç½® |

## ğŸ” æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜

#### 1. æ— çº¿ç”µè®¾å¤‡æœªæ‰¾åˆ°
```bash
# æ£€æŸ¥SPIè®¾å¤‡
ls -la /dev/spidev*

# æ£€æŸ¥USBè®¾å¤‡
lsusb | grep -i lora

# è®¾ç½®RADIODEVç¯å¢ƒå˜é‡
export RADIODEV=/dev/spidev0.0
```

#### 2. æƒé™é—®é¢˜
```bash
# æ·»åŠ ç”¨æˆ·åˆ°dialoutç»„
sudo usermod -a -G dialout $USER

# è®¾ç½®SPIæƒé™
sudo chmod 666 /dev/spidev*
```

#### 3. è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping 8.8.8.8

# æ£€æŸ¥DNSè§£æ
nslookup lns.example.com

# æ£€æŸ¥è¯ä¹¦
openssl x509 -in tc.cert -text -noout
```

#### 4. é…ç½®é—®é¢˜
```bash
# éªŒè¯JSONæ ¼å¼
cat station.conf | jq .

# æ£€æŸ¥é…ç½®å‚æ•°
./station --params

# é‡ç½®é…ç½®ï¼ˆä½¿ç”¨å¤‡ä»½ï¼‰
cp station.conf.bak station.conf
```

### æ—¥å¿—åˆ†æ

#### æ—¥å¿—çº§åˆ«
- `ERROR` (1): é”™è¯¯ä¿¡æ¯
- `WARNING` (2): è­¦å‘Šä¿¡æ¯  
- `NOTICE` (3): é‡è¦é€šçŸ¥
- `INFO` (4): ä¸€èˆ¬ä¿¡æ¯
- `DEBUG` (5): è°ƒè¯•ä¿¡æ¯
- `VERBOSE` (6): è¯¦ç»†ä¿¡æ¯
- `XDEBUG` (7): æè¯¦ç»†è°ƒè¯•

#### æ¨¡å—æ ‡è¯†
- `MOD_SYS`: ç³»ç»Ÿæ¨¡å—
- `MOD_TCE`: TCå¼•æ“
- `MOD_CUP`: CUPSæ¨¡å—
- `MOD_S2E`: S2Eåè®®
- `MOD_RAL`: æ— çº¿ç”µæŠ½è±¡å±‚

#### å…¸å‹æ—¥å¿—æ¨¡å¼
```
# æ­£å¸¸å¯åŠ¨
[SYS:INFO] Starting station...
[TCE:INFO] Starting TC engine
[TCE:INFO] Connecting to INFOS: wss://lns.example.com
[TCE:VERBOSE] Connected to MUXS.

# è¿æ¥é—®é¢˜
[TCE:ERROR] TC connect failed - URI: wss://lns.example.com
[TCE:INFO] INFOS reconnect backoff 10s (retry 1)

# CUPSæ›´æ–°
[CUP:INFO] Starting a CUPS session now.
[CUP:INFO] CUPS provided TC updates (uri) - restarting TC engine
```

### æ€§èƒ½ç›‘æ§

#### å…³é”®æŒ‡æ ‡
```bash
# CPUä½¿ç”¨ç‡
top -p $(pidof station)

# å†…å­˜ä½¿ç”¨
cat /proc/$(pidof station)/status | grep -E "VmRSS|VmSize"

# ç½‘ç»œè¿æ¥
netstat -tulpn | grep station

# æ–‡ä»¶æè¿°ç¬¦
ls -la /proc/$(pidof station)/fd | wc -l
```

#### ç»Ÿè®¡ä¿¡æ¯
- ä¸Šè¡ŒåŒ…è®¡æ•°ï¼š`rxnb`, `rxok`, `rxfw`
- ä¸‹è¡ŒåŒ…è®¡æ•°ï¼š`txnb`, `txok`
- é”™è¯¯è®¡æ•°ï¼šè¿æ¥å¤±è´¥ã€è¶…æ—¶ã€é‡è¯•æ¬¡æ•°

## ğŸ› ï¸ å¼€å‘è°ƒè¯•

### ç¼–è¯‘é€‰é¡¹
```bash
# è°ƒè¯•ç‰ˆæœ¬
make platform=rpi variant=debug

# å¯ç”¨è¯¦ç»†æ—¥å¿—
make platform=rpi variant=std CFLAGS=-DCFG_logfile_lvl=7

# å¯ç”¨æµ‹è¯•åŠŸèƒ½
make platform=rpi variant=std CFLAGS=-DCFG_selftests
```

### GDBè°ƒè¯•
```bash
# ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬
make platform=rpi variant=debug

# å¯åŠ¨GDB
gdb ./build-rpi-debug/bin/station
(gdb) set args -l 7
(gdb) run
```

### å†…å­˜æ£€æŸ¥
```bash
# Valgrindæ£€æŸ¥
valgrind --leak-check=full ./build-rpi-debug/bin/station

# AddressSanitizer
make platform=rpi variant=std CFLAGS=-fsanitize=address
```

## ğŸ“š å‚è€ƒé“¾æ¥

- [å®˜æ–¹æ–‡æ¡£](https://doc.sm.tc/station)
- [GitHubä»“åº“](https://github.com/lorabasics/basicstation)
- [LoRaWANè§„èŒƒ](https://lora-alliance.org/resource_hub/lorawan-specification-v1-1/)
- [Semtech SX130xæ–‡æ¡£](https://www.semtech.com/products/wireless-rf/lora-gateways)

## ğŸ†˜ è·å–å¸®åŠ©

- GitHub Issues: æŠ¥å‘Šbugå’ŒåŠŸèƒ½è¯·æ±‚
- LoRa Developer Portal: æŠ€æœ¯æ”¯æŒ
- ç¤¾åŒºè®ºå›: ç»éªŒåˆ†äº«å’Œè®¨è®º

---

*æœ¬æŒ‡å—æ¶µç›–äº†LoRa Basics Stationçš„æ ¸å¿ƒåŠŸèƒ½å’Œå¸¸è§æ“ä½œã€‚è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£å’Œæºä»£ç æ³¨é‡Šã€‚*